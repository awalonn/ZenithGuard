import"./modulepreload-polyfill-B5Qt9EMX.js";/* empty css              *//* empty css               */document.addEventListener("DOMContentLoaded",()=>{const o=document.getElementById("start-scan-btn"),E=document.getElementById("content-area"),v=document.getElementById("loading-message"),I=document.getElementById("page-domain"),k=document.getElementById("report-page-domain"),w=document.getElementById("scan-status-message"),c=document.getElementById("apply-all-fixes-btn"),m={message:document.getElementById("error-message"),retryBtn:document.getElementById("retry-scan-btn")},M=document.getElementById("api-key-missing-view"),L=document.getElementById("go-to-settings-btn");if(!o||!E||!v||!I||!k||!w||!c||!m.message||!m.retryBtn||!M||!L){console.error("ZenithGuard: Critical UI elements missing in Analyzer.");return}let p=null,u=null,y=null,f=null;const b=["Capturing page content...","Optimizing network data...","Consulting with Gemini AI...","Parsing AI response...","Finalizing suggestions..."];async function S(){const t=new URLSearchParams(window.location.search),e=t.get("tabId"),s=t.get("url");if(!e||!s){document.body.innerHTML="<h1>Error: Missing tab information.</h1>";return}p=parseInt(e,10),u=decodeURIComponent(s);let a="unknown";try{a=new URL(u).hostname}catch{}I&&(I.textContent=a),k&&(k.textContent=a);const{geminiApiKey:r}=await chrome.storage.sync.get("geminiApiKey");if(!r){h("api-key-missing"),o&&(o.style.display="none");return}h("idle");const n=`ai-scan-cache-${u}`,i=await chrome.storage.local.get(n),l=1440*60*1e3;if(i[n]&&Date.now()-i[n].timestamp<l){const g=new Date(i[n].timestamp).toLocaleString();w&&(w.textContent=`Displaying cached report from ${g}.`),o&&(o.textContent="Re-scan Page"),y=i[n].data,C(y)}else A()}async function A(){h("loading"),w&&(w.textContent=""),u&&await chrome.storage.local.remove(`ai-scan-cache-${u}`);try{const t=await chrome.runtime.sendMessage({type:"ANALYZE_PAGE_WITH_AI",data:{tabId:p,pageUrl:u}});if(t.error){if(t.error==="QUOTA_EXCEEDED"){$();return}if(t.error==="AI_TIMEOUT"){B("Analysis timed out. The page might be too complex or the connection is slow.");return}throw new Error(t.error)}y=t.result,C(y)}catch(t){B(t.message)}}function h(t){if(E&&(E.className=`state-${t}`),t==="loading"){let e=0;v&&(v.textContent=b[0]),f&&clearInterval(f),f=window.setInterval(()=>{e=(e+1)%b.length,v&&(v.textContent=b[e])},2e3)}else f&&(clearInterval(f),f=null)}function B(t){h("error"),m.message&&(m.message.textContent=t),o&&(o.textContent="Re-scan Page")}function $(){h("quota-error"),o&&(o.textContent="Re-scan Page")}function C(t){h("report"),o&&(o.textContent="Re-scan Page");const{networkThreats:e=[],visualAnnoyances:s=[],heuristicMatches:a=[],darkPatterns:r=[]}=t,n=document.getElementById("summary-network-threats"),i=document.getElementById("summary-visual-annoyances"),l=document.getElementById("summary-heuristic-issues"),g=document.getElementById("summary-dark-patterns");n&&(n.textContent=e.length.toString()),i&&(i.textContent=s.length.toString()),l&&(l.textContent=a.length.toString()),g&&(g.textContent=r.length.toString());const x=D({network:e.length,visual:s.length,heuristic:a.length,patterns:r.length});H(x.letter,x.percentage);const R=e.length+s.length;R>0&&c?(c.classList.remove("hidden"),c.textContent=`Apply ${R} AI Fixes`,c.disabled=!1):c&&c.classList.add("hidden"),P(e),T(s),U(a),N(r)}function D(t){const e=t.network+t.visual+t.heuristic+t.patterns*5;return e===0?{letter:"A",percentage:100}:e<=2?{letter:"B",percentage:85}:e<=5?{letter:"C",percentage:70}:e<=10?{letter:"D",percentage:55}:{letter:"F",percentage:40}}function H(t,e){const s=document.querySelector(".gauge-arc"),a=document.querySelector(".gauge-text"),r=2*Math.PI*54,n=e/100*r;s&&(s.style.strokeDasharray=`${n}, ${r}`),a&&(a.textContent=t)}function P(t){const e=document.getElementById("network-threats-content");if(!e)return;if(!t||t.length===0){e.innerHTML='<p class="no-results-message">No network threats detected.</p>';return}const s=t.reduce((a,r)=>{const n=r.category||"General";return a[n]||(a[n]=[]),a[n].push(r),a},{});e.innerHTML=Object.entries(s).map(([a,r])=>`
            <div class="threat-category">
                <h3 class="category-header" style="border-color: ${a==="Ads"?"#ef4444":"#f97316"};">${a}</h3>
                ${r.map(n=>`
                    <div class="threat-entry">
                        <div class="threat-url">${d(n.url)}</div>
                        <div class="threat-reason">${d(n.reason||"")}</div>
                        <div class="threat-actions">
                            <button class="threat-action-btn" data-ruletype="networkBlocklist" data-value="${new URL(n.url).hostname}">Block Domain</button>
                        </div>
                    </div>`).join("")}
            </div>`).join("")}function T(t){const e=document.getElementById("visual-suggestions-content");if(e){if(!t||t.length===0){e.innerHTML='<p class="no-results-message">No visual annoyances suggested.</p>';return}e.innerHTML=t.map(s=>`
            <div class="suggestion-card">
                <div>
                    <p class="suggestion-description">${d(s.description)}</p>
                    <code class="suggestion-selector">${d(s.suggestedSelector)}</code>
                </div>
                <div class="suggestion-actions">
                    <button class="suggestion-preview-btn" data-selector="${d(s.suggestedSelector)}">Preview</button>
                    <button class="suggestion-add-btn" data-ruletype="customHidingRules" data-value="${d(s.suggestedSelector)}">Add Rule</button>
                </div>
            </div>`).join("")}}function U(t){const e=document.getElementById("heuristic-keywords-content");if(e){if(!t||t.length===0){e.innerHTML='<p class="no-results-message">No heuristic keyword matches found.</p>';return}e.innerHTML=t.map(s=>`
             <div class="threat-entry">
                <div class="threat-url">${d(s.url)}</div>
                <div class="threat-reason">Matched keyword: <code>${d(s.keyword)}</code></div>
                 <div class="threat-actions">
                    <button class="threat-action-btn" data-ruletype="heuristicKeywords" data-value="${d(s.keyword)}">Add to Engine</button>
                </div>
            </div>`).join("")}}function N(t){const e=document.getElementById("dark-patterns-content");if(e){if(!t||t.length===0){e.innerHTML='<p class="no-results-message">No deceptive UI patterns detected.</p>';return}e.innerHTML=t.map(s=>`
            <div class="pattern-card">
                <p class="pattern-name">${d(s.patternName)}</p>
                <p class="pattern-description">${d(s.description)}</p>
            </div>`).join("")}}c&&c.addEventListener("click",async()=>{if(!y||!u)return;c.disabled=!0,c.textContent="Applying...";const{networkThreats:t=[],visualAnnoyances:e=[]}=y;let s="unknown";try{s=new URL(u).hostname}catch{}const a=t.map(n=>new URL(n.url).hostname),r=e.map(n=>n.suggestedSelector);await chrome.runtime.sendMessage({type:"BULK_ADD_RULES",data:{networkBlocklist:[...new Set(a)],customHidingRules:{domain:s,selectors:[...new Set(r)]}}}),c.textContent="Fixes Applied!",document.querySelectorAll(".threat-action-btn, .suggestion-add-btn").forEach(n=>{n.dataset.ruletype&&["networkBlocklist","customHidingRules"].includes(n.dataset.ruletype)&&(n.textContent="Added!",n.classList.add("added"),n.disabled=!0)})}),document.body.addEventListener("click",async t=>{const e=t.target;if(e.dataset&&e.dataset.ruletype&&e.dataset.value&&!e.disabled){const s=e.dataset.ruletype,a=e.dataset.value;let n=(await chrome.storage.sync.get(s))[s]||(s==="customHidingRules"?{}:[]),i=!1;if(s==="customHidingRules"){let l="unknown";if(u)try{l=new URL(u).hostname}catch{}n[l]||(n[l]=[]),i=n[l].some(g=>g.value===a),i||n[l].push({value:a,enabled:!0})}else i=n.some(l=>l.value===a),i||n.push({value:a,enabled:!0});i||(await chrome.storage.sync.set({[s]:n}),e.textContent="Added!",e.classList.add("added"),e.disabled=!0)}if(e.classList.contains("suggestion-preview-btn")){const s=e.classList.toggle("active");document.querySelectorAll(".suggestion-preview-btn.active").forEach(r=>{r!==e&&r.classList.remove("active")});const a=e.dataset.selector;p&&a&&chrome.tabs.sendMessage(p,{type:s?"PREVIEW_ELEMENT":"CLEAR_PREVIEW",selector:a}).catch(()=>{})}}),window.addEventListener("beforeunload",()=>{p&&chrome.tabs.sendMessage(p,{type:"CLEAR_PREVIEW"}).catch(()=>{})});function d(t){return typeof t!="string"?"":t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}o&&o.addEventListener("click",A),m.retryBtn&&m.retryBtn.addEventListener("click",A),L&&L.addEventListener("click",()=>chrome.runtime.openOptionsPage()),S()});
