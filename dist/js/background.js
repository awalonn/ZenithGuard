import{B as G}from"./subscription_presets-Cex1emRe.js";const O=["utm_source","utm_medium","utm_campaign","utm_term","utm_content","fbclid","fbc","gclid","gclsrc","dclid","_hsenc","_hsmi","hsCtaTracking","mkt_tok","mc_cid","mc_eid","vero_id","yclid","_openstat","rb_clickid","s_cid"];function me(e,t){if(!O.length)return[];const r=[];let s=e;const a=15;for(let o=0;o<O.length;o+=a){const i=`[?&](${O.slice(o,o+a).join("|")})=`,l={id:s++,priority:1,action:{type:"redirect",redirect:{transform:{queryTransform:{removeParams:O}}}},condition:{regexFilter:i,resourceTypes:["main_frame","sub_frame"]}};t&&t.length>0&&(l.condition.excludedInitiatorDomains=t),r.push(l)}return r}const he="https://raw.githubusercontent.com/StevenBlack/hosts/master/hosts",K="malware-list-cache";async function B(){try{console.log("ZenithGuard: Updating malware domain list...");const e=await fetch(he,{signal:AbortSignal.timeout(3e4)});if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const t=await e.text(),r=ge(t);await chrome.storage.local.set({[K]:{domains:r,lastUpdated:Date.now()}}),console.log(`ZenithGuard: Malware list updated with ${r.length} domains.`)}catch(e){console.error("ZenithGuard: Failed to update malware list.",e)}}function ge(e){const t=new Set,r=e.split(`
`);for(const s of r){const a=s.trim();if(a.startsWith("#")||!a)continue;const o=a.split(/\s+/);if(o.length>=2&&(o[0]==="0.0.0.0"||o[0]==="127.0.0.1")){const n=o[1];n&&n.includes(".")&&n!=="localhost"&&t.add(n)}}return Array.from(t)}async function fe(e,t,r){let a=(await chrome.storage.local.get(K))[K]?.domains||[];const o=["wpadmngr.com","js.wpadmngr.com"];if(a=[...new Set([...a,...o])],a.length===0)return[];const n=[],i=chrome.runtime.getURL("src/pages/blocked.html"),l=4e3;for(let c=0;c<a.length;c+=l){if(n.length>=r){console.warn(`ZenithGuard: Malware protection rule budget (${r}) reached. Not all malware domains will be loaded.`);break}const u=a.slice(c,c+l);n.push({id:e+n.length,priority:1,action:{type:"redirect",redirect:{url:i}},condition:{requestDomains:u,resourceTypes:["main_frame"],excludedInitiatorDomains:t.length>0?t:void 0}})}return n}const pe=7e3,ye=["facebook.com","twitter.com","x.com","instagram.com","tiktok.com","reddit.com","youtube.com","netflix.com","twitch.tv","discord.com","pinterest.com","tumblr.com","9gag.com","imgur.com","buzzfeed.com"];async function we(){const e=await chrome.storage.sync.get(["isFocusModeEnabled","focusModeUntil","focusBlocklist"]);return!e.focusModeUntil||e.focusModeUntil<Date.now()?(e.isFocusModeEnabled&&await chrome.storage.sync.set({isFocusModeEnabled:!1}),[]):(e.focusBlocklist&&e.focusBlocklist.length>0?e.focusBlocklist:ye).map((s,a)=>({id:pe+a,priority:1,action:{type:chrome.declarativeNetRequest.RuleActionType.REDIRECT,redirect:{extensionPath:"/src/pages/focus_blocked.html"}},condition:{urlFilter:`||${s}`,resourceTypes:[chrome.declarativeNetRequest.ResourceType.MAIN_FRAME]}}))}async function be(e){const t=Date.now()+e*60*1e3;await chrome.storage.sync.set({isFocusModeEnabled:!0,focusModeUntil:t})}async function Ee(){await chrome.storage.sync.set({isFocusModeEnabled:!1,focusModeUntil:0})}const W=100,te=1e3,Re=5e3,re=6e3,Te=7e3,se=15e3,j=18e3,Z=2e4,ae=6e4,oe=8e4,X=90,Ae=8;let M=!1;function Se(e){if(e>=oe)return"Default Blocklist";if(e>=ae)return"User Allowlist";if(e>=Z)return"Filter List";if(e>=j)return"Malware Protection";if(e>=se)return"URL Cleaner";if(e>=Te)return"Focus Mode";if(e>=re)return"Isolation Mode";if(e>=Re)return"YouTube Ads";if(e>=te)return"Network Blocklist";if(e>=W)return"Heuristic Engine";const t=G.find(r=>r.id===String(e));return t?t.name:"Unknown"}function Ie(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}async function w(){if(M){console.log("ZenithGuard: Rule application already in progress.");return}M=!0;try{const t=(await chrome.declarativeNetRequest.getDynamicRules()).map(y=>y.id),r=await chrome.storage.sync.get(["isHeuristicEngineEnabled","heuristicKeywords","heuristicAllowlist","networkBlocklist","defaultBlocklist","disabledSites","isUrlCleanerEnabled","isMalwareProtectionEnabled","isolationModeSites","isYouTubeAdBlockingEnabled","filterLists","enabledStaticRulesets","isProtectionEnabled"]),{isProtectionEnabled:s=!0}=r,{protectionPausedUntil:a}=await chrome.storage.session.get("protectionPausedUntil"),o=a&&a>Date.now(),n=["easylist","easyprivacy","annoyances","youtube"];if(!s||o){t.length>0&&await chrome.declarativeNetRequest.updateDynamicRules({removeRuleIds:t}),await chrome.declarativeNetRequest.updateEnabledRulesets({disableRulesetIds:n}),console.log(o?"ZenithGuard: Protection paused. All rules disabled.":"ZenithGuard: Protection globally disabled. All rules disabled."),M=!1;return}const i=new Set,l=new Set(r.enabledStaticRulesets||[]);r.isYouTubeAdBlockingEnabled&&i.add("youtube"),(l.has("easylist")||l.size===0)&&i.add("easylist"),(l.has("easyprivacy")||l.size===0)&&i.add("easyprivacy"),(l.has("annoyances")||l.has("ublock_annoyances")||l.size===0)&&i.add("annoyances");const c=Array.from(i),u=n.filter(y=>!i.has(y));await chrome.declarativeNetRequest.updateEnabledRulesets({enableRulesetIds:c,disableRulesetIds:u});let d=[];const h=r.disabledSites||[];if(h.length>0){let y=ae;const E=[];for(const b of h)E.push({id:y++,priority:99,action:{type:"allow"},condition:{requestDomains:[b],resourceTypes:["main_frame","sub_frame","script","xmlhttprequest","image","media","stylesheet","other"]}}),E.push({id:y++,priority:99,action:{type:"allow"},condition:{initiatorDomains:[b],resourceTypes:["main_frame","sub_frame","script","xmlhttprequest","image","media","stylesheet","other"]}});d.push(...E)}let f=(chrome.declarativeNetRequest.MAX_NUMBER_OF_DYNAMIC_RULES||5e3)-d.length;const _=[_e(r.isolationModeSites),await we(),r.isHeuristicEngineEnabled?ke(r.heuristicKeywords,r.heuristicAllowlist||[]):[],Le(r.defaultBlocklist),Ue(r.networkBlocklist),r.isUrlCleanerEnabled?me(se,[]):[]];for(const y of _){if(f<=0)break;const E=y.slice(0,f);d.push(...E),f-=E.length}if(r.isMalwareProtectionEnabled&&f>0){const y=await fe(j,[],f);d.push(...y)}(t.length>0||d.length>0)&&await chrome.declarativeNetRequest.updateDynamicRules({removeRuleIds:t,addRules:d})}catch(e){console.error("ZenithGuard: Failed to apply dynamic rules.",e)}finally{M=!1}}function _e(e){return e?e.filter(t=>t.enabled).map((t,r)=>({id:re+r,priority:1,action:{type:"block"},condition:{initiatorDomains:[t.value],domainType:"thirdParty",resourceTypes:["script","object","sub_frame"]}})):[]}function ke(e,t){const r=[];if(!e||e.length===0)return r;const s=e.filter(c=>c.enabled).map(c=>Ie(c.value));if(s.length===0)return r;const a=(t||[]).filter(c=>c.enabled).map(c=>c.value),o=a.length>0?a:void 0;let n=[],i=0,l=0;for(const c of s){if(c.length>X){console.warn(`ZenithGuard: Heuristic keyword starting with "${c.substring(0,50)}..." is too long and will be skipped.`);continue}const u=i>0&&i+c.length+1>X,d=n.length>=Ae;if(u||d){const h=n.join("|");r.push({id:W+l++,priority:2,action:{type:"block"},condition:{regexFilter:h,resourceTypes:["main_frame","sub_frame","script","xmlhttprequest"],excludedInitiatorDomains:o}}),n=[c],i=c.length}else i>0&&(i+=1),n.push(c),i+=c.length}return n.length>0&&r.push({id:W+l,priority:2,action:{type:"block"},condition:{regexFilter:n.join("|"),resourceTypes:["main_frame","sub_frame","script","xmlhttprequest"],excludedInitiatorDomains:o}}),r}function Le(e){return e?e.filter(t=>t.enabled).map((t,r)=>{const a=t.value.startsWith("/")&&(t.value.endsWith("/")||t.value.endsWith("/i"))?{regexFilter:t.value.slice(1,-1),resourceTypes:["main_frame","sub_frame","script","xmlhttprequest"]}:{urlFilter:t.value,resourceTypes:["main_frame","sub_frame","script","xmlhttprequest","image","media","websocket","other"]};return{id:oe+r,priority:2,action:{type:"block"},condition:a}}):[]}function Ue(e){return e?e.filter(t=>t.enabled).map((t,r)=>({id:te+r,priority:1,action:{type:"block"},condition:{urlFilter:`||${t.value}^`,resourceTypes:["main_frame","sub_frame","script","xmlhttprequest","image","media","websocket","other"]}})):[]}const z=["/ads/","-ads-","_ads_","/advert/","adserver.","adservice.","ad-delivery","third-party-ads","/track.js","/tracking.","/beacon.","/pixel.","/collect?","analytics.js","metrics.","track.gif","telemetry","fingerprint","user-identification","popunder","adloader","prebid","doubleclick","affiliate","offer-wall"],ne=[{value:"||doubleclick.net^",enabled:!0},{value:"||google-analytics.com^",enabled:!0},{value:"||googletagmanager.com^",enabled:!0},{value:"||googlesyndication.com^",enabled:!0},{value:"||facebook.net^",enabled:!0},{value:"||connect.facebook.net^",enabled:!0},{value:"||criteo.com^",enabled:!0},{value:"||adroll.com^",enabled:!0},{value:"||rubiconproject.com^",enabled:!0},{value:"||outbrain.com^",enabled:!0},{value:"||taboola.com^",enabled:!0},{value:"||scorecardresearch.com^",enabled:!0},{value:"||quantserve.com^",enabled:!0},{value:"||hotjar.com^",enabled:!0},{value:"||mixpanel.com^",enabled:!0},{value:"||segment.com^",enabled:!0},{value:"||optimizely.com^",enabled:!0},{value:"||crazyegg.com^",enabled:!0},{value:"||adnxs.com^",enabled:!0},{value:"||pubmatic.com^",enabled:!0},{value:"adservice.",enabled:!0},{value:"adserver.",enabled:!0},{value:"pagead/",enabled:!0},{value:"prebid.",enabled:!0},{value:"/ad-logic.",enabled:!0},{value:"/ad-delivery/",enabled:!0},{value:"/ads/banner.",enabled:!0},{value:"/ads/preroll.",enabled:!0}];async function De(){const e=["networkBlocklist","heuristicKeywords","heuristicAllowlist","isolationModeSites","forgetfulSites"],t=await chrome.storage.sync.get(e);let r=!1;for(const d of e)t[d]&&Array.isArray(t[d])&&t[d].length>0&&typeof t[d][0]=="string"&&(console.log(`ZenithGuard: Migrating old rule format for "${d}"...`),t[d]=t[d].map(h=>({value:h,enabled:!0})),r=!0);const{customHidingRules:s={}}=await chrome.storage.sync.get("customHidingRules");let a=!1;for(const d in s)Array.isArray(s[d])&&s[d].length>0&&typeof s[d][0]=="string"&&(s[d]=s[d].map(h=>({value:h,enabled:!0})),a=!0);const o=[];r&&o.push(chrome.storage.sync.set(t)),a&&o.push(chrome.storage.sync.set({customHidingRules:s}));const n=await chrome.storage.sync.get(["trackerListUrl","youtubeRulesUrl"]);let i=!1;n.trackerListUrl&&n.trackerListUrl.includes("YOUR_USERNAME")&&(n.trackerListUrl="https://gist.githubusercontent.com/awalonn/6d72d652200fe4aa16fd7cba3c47e573/raw/c39c25acc9ca31f99f1ae6dbc792024263b5e2c7/trackers.json",i=!0);const{heuristicKeywords:l=[]}=await chrome.storage.sync.get("heuristicKeywords"),c=new Set(l.map(d=>d.value));let u=!1;for(const d of z)c.has(d)||(console.log(`ZenithGuard: Adding new heuristic keyword: ${d}`),l.push({value:d,enabled:!0}),c.add(d),u=!0);u&&o.push(chrome.storage.sync.set({heuristicKeywords:l})),n.youtubeRulesUrl&&n.youtubeRulesUrl.includes("YOUR_USERNAME")&&(n.youtubeRulesUrl="https://gist.githubusercontent.com/awalonn/446737a854b3b3016b6b4ab9bd35e32b/raw/29c7e5c4bdb9b8f3381f14d585005fde328725d4/youtube_rules.json",i=!0),i&&o.push(chrome.storage.sync.set(n)),o.length>0&&(await Promise.all(o),console.log("ZenithGuard: Rule migration complete."))}async function ve(){await chrome.storage.sync.set({defaultBlocklist:ne.map(e=>({value:e.value,enabled:e.enabled})),heuristicKeywords:z.map(e=>({value:e,enabled:!0})),networkBlocklist:[],customHidingRules:{},heuristicAllowlist:[],isolationModeSites:[],forgetfulSites:[]})}async function ie(){const{settingsInitialized:e,autoAiDisabledOnce:t}=await chrome.storage.sync.get(["settingsInitialized","autoAiDisabledOnce"]);t||(console.log("ZenithGuard: Temporarily disabling automatic AI features to restore your Gemini quota."),await chrome.storage.sync.set({isCookieBannerHidingEnabled:!1,isSelfHealingEnabled:!1,autoAiDisabledOnce:!0})),!e&&(console.log("ZenithGuard: First run or settings missing. Initializing default settings."),await chrome.storage.sync.set({isHeuristicEngineEnabled:!0,isUrlCleanerEnabled:!0,isMalwareProtectionEnabled:!0,isYouTubeAdBlockingEnabled:!0,isSandboxedIframeEnabled:!0,isCookieBannerHidingEnabled:!1,isSelfHealingEnabled:!1,isPerformanceModeEnabled:!1,isBreachWarningEnabled:!0,theme:"dark",isProtectionEnabled:!0,filterLists:[{url:"https://easylist.to/easylist/easylist.txt",enabled:!0,status:"new"}],defaultBlocklist:ne.map(r=>({value:r.value,enabled:r.enabled})),heuristicKeywords:z.map(r=>({value:r,enabled:!0})),networkBlocklist:[],customHidingRules:{},heuristicAllowlist:[],isolationModeSites:[],forgetfulSites:[],settingsInitialized:!0}))}async function Ce(e,t){const r=new Date().toISOString().slice(0,10),{dailyBlocks:s={},dailyPerformance:a={}}=await chrome.storage.local.get(["dailyBlocks","dailyPerformance"]);s[r]||(s[r]={ads:0,trackers:0}),e==="ad"?s[r].ads=(s[r].ads||0)+1:e==="tracker"&&(s[r].trackers=(s[r].trackers||0)+1),a[r]||(a[r]={totalWeight:0,blockedWeight:0});const n=({image:150,media:1500,script:50,sub_frame:300,xmlhttprequest:10,websocket:5,font:30,stylesheet:20,other:10}[t]||10)*1024;a[r].blockedWeight+=n,a[r].totalWeight+=n*10;const i=Object.keys(s).sort();i.length>30&&i.slice(0,i.length-30).forEach(c=>{delete s[c],delete a[c]}),await chrome.storage.local.set({dailyBlocks:s,dailyPerformance:a})}const Ne=1440*60*1e3;function Oe(e){const t=new Set,r={},s=e.split(`
`);for(const a of s){const o=a.trim();if(!(!o||o.startsWith("!")||o.startsWith("[")))if(o.includes("##")){const n=o.split("##"),i=n[0],l=n[1],c=i.split(",").filter(u=>u&&!u.startsWith("~"));if(c.length>0)for(const u of c)r[u]||(r[u]=[]),r[u].push(l);else r[""]||(r[""]=[]),r[""]=r[""].concat(l)}else{if(o.startsWith("@@"))continue;t.add(o)}}return{networkRules:Array.from(t),cosmeticRules:r}}async function x(e=!1){const{filterLists:t=[]}=await chrome.storage.sync.get("filterLists"),{enabledStaticRulesets:r=[]}=await chrome.storage.sync.get("enabledStaticRulesets"),s=[...t];for(const o of G)r.includes(o.id)&&o.sourceUrl&&s.push({id:o.id,url:o.sourceUrl,enabled:!0,name:o.name});const a=[];for(const o of s){if(!o.enabled||!o.url)continue;const n=`filterlist-${o.url}`;if(!e){const i=await chrome.storage.local.get(n);if(i[n]&&Date.now()-i[n].lastUpdated<Ne)continue}a.push(ce(o))}a.length>0&&(console.log(`ZenithGuard: Updating ${a.length} filter lists...`),await Promise.all(a),console.log("ZenithGuard: Filter list update complete."),await w())}async function ce(e){const t=!G.some(a=>a.id===e.id),{filterLists:r=[]}=await chrome.storage.sync.get("filterLists"),s=a=>a.url===e.url;try{if(t){const u=r.find(s);u&&(u.status="updating",await chrome.storage.sync.set({filterLists:r}))}const a=await fetch(e.url,{signal:AbortSignal.timeout(6e4)});if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);const o=await a.text(),{networkRules:n,cosmeticRules:i}=Oe(o);if(n.length===0&&Object.keys(i).length===0)throw new Error("Parsing resulted in empty rule sets. The list might be unavailable or invalid.");const l={networkRules:t?n:[],cosmeticRules:i,lastUpdated:Date.now()},c=`filterlist-${e.url}`;if(await chrome.storage.local.set({[c]:l}),t){const d=(await chrome.storage.sync.get("filterLists")).filterLists||[],h=d.find(s);h&&(h.status="success",h.ruleCount=n.length+Object.values(i).reduce((g,f)=>g+f.length,0),h.lastUpdated=Date.now(),await chrome.storage.sync.set({filterLists:d}))}else console.log(`ZenithGuard: Updated cached rules for preset ${e.id} (${e.name}).`)}catch(a){if(console.error(`ZenithGuard: Failed to update filter list ${e.url}.`,a),t){const n=(await chrome.storage.sync.get("filterLists")).filterLists||[],i=n.find(s);i&&(i.status="error",await chrome.storage.sync.set({filterLists:n}))}}}async function Me(e){const{filterLists:t=[],isPerformanceModeEnabled:r,disabledSites:s=[]}=await chrome.storage.sync.get(["filterLists","isPerformanceModeEnabled","disabledSites"]);if(r||s.includes(e))return{rules:[]};let a=[];try{const n=await chrome.declarativeNetRequest.getEnabledRulesets();for(const i of G)if(n.includes(i.id)){if(i.sourceUrl){const d=`filterlist-${i.sourceUrl}`,g=(await chrome.storage.local.get(d))[d]?.cosmeticRules;if(g){const f=(g[e]||[]).concat(g[""]||[]);a.push(...f);continue}}const l=chrome.runtime.getURL(i.cosmeticRulesUrl),u=await(await fetch(l)).json();if(u){const d=(u[e]||[]).concat(u[""]||[]);a.push(...d)}}}catch(n){console.error("ZenithGuard: Failed to load bundled cosmetic rules.",n)}const o=(t||[]).filter(n=>n.enabled&&n.status==="success");for(const n of o){if(!n.url)continue;const i=`filterlist-${n.url}`,c=(await chrome.storage.local.get(i))[i]?.cosmeticRules;if(c){const u=(c[e]||[]).concat(c[""]||[]);a.push(...u)}}return{rules:a.map(n=>({value:n,enabled:!0}))}}const Pe="https://generativelanguage.googleapis.com/v1beta/models";var m=(e=>(e.TYPE_UNSPECIFIED="TYPE_UNSPECIFIED",e.STRING="STRING",e.NUMBER="NUMBER",e.INTEGER="INTEGER",e.BOOLEAN="BOOLEAN",e.ARRAY="ARRAY",e.OBJECT="OBJECT",e.NULL="NULL",e))(m||{});class Ge{apiKey;constructor(t){this.apiKey=t}async generateContent(t){if(!t.model)throw new Error("Model name is required.");const r=t.model,s=`${Pe}/${r}:generateContent?key=${this.apiKey}`;console.log(`ZenithGuard: Calling Gemini API at .../models/${r}:generateContent`);const a={contents:Array.isArray(t.contents)?t.contents:[t.contents]};t.config&&(a.generationConfig={temperature:t.config.temperature,responseMimeType:t.config.responseMimeType,responseSchema:t.config.responseSchema}),t.systemInstruction&&(a.systemInstruction=t.systemInstruction);const o=3;for(let n=0;n<o;n++)try{const i=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!i.ok){let u;try{u=await i.json()}catch{throw new Error(`HTTP error ${i.status}: ${i.statusText}`)}const d=u?.error?.message||JSON.stringify(u);if(i.status===429||d.toLowerCase().includes("quota"))throw new Error("QUOTA_EXCEEDED");if(i.status>=500&&n<o-1){const g=Math.pow(2,n)*1e3+Math.random()*1e3;await new Promise(f=>setTimeout(f,g));continue}throw new Error(d)}return{text:(await i.json()).candidates?.[0]?.content?.parts?.[0]?.text||""}}catch(i){const l=i;if(l.name==="AbortError")throw console.error("Gemini API request timed out."),new Error("API request timed out.");if(l.message==="QUOTA_EXCEEDED")throw console.warn("Gemini API quota exceeded."),l;if(n===o-1)throw console.error("Error calling Gemini API after all retries:",l.message),l}throw new Error("Gemini API request failed after all retries.")}}class Be{models;apiKey;constructor(t){if(!t||!t.apiKey)throw new Error("API key is required for GoogleGenAI client.");this.apiKey=t.apiKey,this.models=new Ge(this.apiKey)}}const A="gemini-3-flash-preview";let V=0;const Q=15e3,xe=50,q=20,Fe=50,He=200,D=.1;let L=null;class Ye{queue=[];isProcessing=!1;lastCaptureTime=0;MIN_INTERVAL=600;async capture(t,r){return new Promise((s,a)=>{this.queue.push(async()=>{try{const n=Date.now()-this.lastCaptureTime;n<this.MIN_INTERVAL&&await new Promise(l=>setTimeout(l,this.MIN_INTERVAL-n)),this.lastCaptureTime=Date.now();const i=await chrome.tabs.captureVisibleTab(t,r);s(i)}catch(o){a(o)}}),this.processQueue()})}async processQueue(){if(!this.isProcessing){for(this.isProcessing=!0;this.queue.length>0;){const t=this.queue.shift();t&&await t()}this.isProcessing=!1}}}const v=new Ye;function $e(){L=null}async function Ke(){const t=Date.now()-V;if(t<Q){const r=Q-t;console.log(`ZenithGuard: Global AI rate limit hit. Throttling for ${Math.round(r/1e3)}s...`),await new Promise(s=>setTimeout(s,r))}V=Date.now()}async function S(){if(await Ke(),L)return L;const{geminiApiKey:e}=await chrome.storage.sync.get("geminiApiKey");if(!e)throw new Error("Gemini API key is not set. Please set it in the extension settings.");return L=new Be({apiKey:e}),L}async function C(e,t,r={requireFocus:!0}){let s;try{s=await chrome.tabs.get(e)}catch{throw new Error(`Target tab with ID ${e} not found. It may have been closed.`)}if(!s.url)throw new Error("Tab has no URL.");if(s.url.startsWith("chrome:")||s.url.startsWith("edge:")||s.url.startsWith("about:")||s.url.startsWith("mozilla:")||s.url.startsWith("view-source:"))throw new Error(`Cannot capture restricted page: ${s.url}`);if(s.url.startsWith("file:")&&!await chrome.extension.isAllowedFileSchemeAccess())throw new Error("File access not enabled. Please enable 'Allow access to file URLs' in extension settings.");if(r.requireFocus){try{await chrome.windows.update(s.windowId,{focused:!0}),await chrome.tabs.update(e,{active:!0})}catch(a){throw String(a.message).includes("Tabs cannot be edited right now")?new Error("Action aborted: User is interacting with the tab strip."):String(a.message).includes("No tab with id")?new Error("The target tab was closed before the action could complete."):a}await new Promise(a=>setTimeout(a,500))}try{await chrome.tabs.get(e)}catch{throw new Error("The target tab was closed before the action could complete.")}return await t(s)}function I(e){try{if(!e)return{};const t=e.replace(/```json\n?|\n?```/g,"").trim();return JSON.parse(t)}catch(t){return console.warn("ZenithGuard: Failed to parse AI JSON response.",t),{}}}function N(e,t){const r=e.message;return r==="QUOTA_EXCEEDED"?(console.warn(`ZenithGuard ${t}: Quota exceeded.`),{error:"QUOTA_EXCEEDED"}):r.includes("Target tab with ID")||r.includes("target tab was closed")||r.includes("No tab with id")?(console.warn(`ZenithGuard ${t}: Tab was closed, action aborted.`),{error:"TAB_CLOSED"}):(console.error(`ZenithGuard ${t} Error:`,r),{error:r})}async function We(e,t,r){try{const s=await C(e,async l=>{const c=await S();if(!c.models)throw new Error("AI models not initialized");const d=(await v.capture(l.windowId,{format:"jpeg",quality:xe})).split(",")[1],h=(r||[]).filter(b=>b.status==="blocked"&&(b.type==="script"||b.type==="xmlhttprequest")).map(b=>b.url.substring(0,He)).slice(0,Fe),g=`Analyze the provided webpage screenshot and network log for privacy threats, visual annoyances, and manipulative "dark patterns".
            - Network log contains blocked third-party tracking scripts.
            - The user wants to block ads, trackers, popups, and other intrusive elements.
            - Identify distinct visual elements that are likely ads, banners, or annoyances. For each, provide a UNIQUE and ROBUST CSS selector.
            - Identify network requests that are clearly for tracking or advertising.
            - Identify network requests that match common heuristic patterns for tracking (e.g., contains '/track.js', 'analytics', '/beacon').
            - Identify manipulative UI "dark patterns" like Confirm-shaming (e.g., "No, I don't want to save money"), Roach Motel (easy to sign up, hard to cancel), Hidden Costs, or forced continuity.
            - Be concise. Focus on actionable items. Do not suggest blocking core site functionality.`,f={type:m.OBJECT,properties:{networkThreats:{type:m.ARRAY,items:{type:m.OBJECT,properties:{url:{type:m.STRING},category:{type:m.STRING},reason:{type:m.STRING}}}},visualAnnoyances:{type:m.ARRAY,items:{type:m.OBJECT,properties:{description:{type:m.STRING},suggestedSelector:{type:m.STRING}}}},heuristicMatches:{type:m.ARRAY,items:{type:m.OBJECT,properties:{url:{type:m.STRING},keyword:{type:m.STRING}}}},darkPatterns:{type:m.ARRAY,description:"Deceptive UI patterns designed to trick users.",items:{type:m.OBJECT,properties:{patternName:{type:m.STRING},description:{type:m.STRING}}}}}},_=new Promise((b,de)=>setTimeout(()=>de(new Error("AI_TIMEOUT")),4e4)),y=c.models.generateContent({model:A,contents:{parts:[{text:g},{inlineData:{mimeType:"image/jpeg",data:d}},{text:`Network Log:
${h.join(`
`)}`}]},config:{responseMimeType:"application/json",responseSchema:f,temperature:D}}),E=await Promise.race([y,_]);return I(E.text)}),{auditHistory:a=[]}=await chrome.storage.local.get("auditHistory"),o=(s.networkThreats?.length||0)+(s.visualAnnoyances?.length||0)+(s.heuristicMatches?.length||0)+(s.darkPatterns?.length||0),n=o===0?"A":o<=5?"B":o<=10?"C":"D";let i="unknown";try{i=new URL(t).hostname}catch{console.warn("ZenithGuard: Invalid URL for audit history:",t)}return a.unshift({url:t,domain:i,date:Date.now(),grade:n,threatCount:o}),a.length>50&&a.pop(),await chrome.storage.local.set({auditHistory:a}),await chrome.storage.local.set({[`ai-scan-cache-${t}`]:{data:s,timestamp:Date.now()}}),{result:s}}catch(s){return N(s,"AI Analyzer")}}async function Ze(e,t){try{return await C(t.tabId,async s=>{const a=await S();if(!a.models)throw new Error("AI models not initialized");const n=(await v.capture(s.windowId,{format:"jpeg",quality:q})).split(",")[1];let i=`Analyze the provided webpage screenshot. The user wants to hide an element they've described as: "${e}". Based on this description and the visual context of the screenshot, generate the most robust and specific CSS selector possible to uniquely identify and hide this element.`;t&&t.tag&&(i+=` The user initially clicked on a <${t.tag}> element`,t.text&&(i+=` containing text like "${t.text}".`),t.classes&&(i+=` with classes "${t.classes}".`));const l={type:m.OBJECT,properties:{reasoning:{type:m.STRING},selector:{type:m.STRING}}},c=await a.models.generateContent({model:A,contents:{parts:[{text:i},{inlineData:{mimeType:"image/jpeg",data:n}}]},config:{responseMimeType:"application/json",responseSchema:l,temperature:D}}),u=I(c.text);if(!u.selector||u.selector.trim()==="")throw new Error("AI failed to generate a valid selector.");return{selector:u.selector.trim()}})}catch(r){return N(r,"AI Hider")}}async function je(e){try{const t=await S();if(!t.models)throw new Error("AI models not initialized");const r=await fetch(e,{signal:AbortSignal.timeout(15e3)});if(!r.ok)throw new Error("Could not fetch the policy page.");const s=await r.text(),a=`You are a privacy expert. Analyze the text from this privacy policy and provide a brief, easy-to-understand summary. Extract key data points. Respond ONLY with the JSON object.
        - "summary": A single, concise sentence (max 25 words) summarizing their main data practice (e.g., "Collects usage data to personalize ads and shares it with partners.").
        - "dataCollected": An array of strings categorizing the data they collect (e.g., "Personal Info", "Location", "Usage Data", "Contact Info", "Financial Info").
        - "sharedWith": An array of strings describing who they share data with (e.g., "Advertisers", "Affiliates", "Law Enforcement", "Analytics Partners").`,o={type:m.OBJECT,properties:{summary:{type:m.STRING},dataCollected:{type:m.ARRAY,items:{type:m.STRING}},sharedWith:{type:m.ARRAY,items:{type:m.STRING}}},required:["summary","dataCollected","sharedWith"]},n=await t.models.generateContent({model:A,contents:{parts:[{text:`Privacy Policy Text:

${s}`}]},systemInstruction:{parts:[{text:a}]},config:{responseMimeType:"application/json",responseSchema:o,temperature:0}});return I(n.text)}catch(t){return console.error("ZenithGuard: Failed to summarize privacy policy:",t),{error:t.message}}}async function ze(e,t,r){try{return await C(t,async a=>{const o=await S();if(!o.models)throw new Error("AI models not initialized");const i=(await v.capture(a.windowId,{format:"jpeg",quality:q})).split(",")[1],l=`On the webpage at ${r}, the following CSS selector was used to hide an unwanted element, but it no longer works: "${e}". 
            Based on the screenshot, analyze the page and generate a NEW, robust CSS selector that targets the element this old selector was most likely trying to hide.
            The element is probably an ad, a banner, a newsletter signup, or a similar annoyance. Prioritize stable attributes.`,c={type:m.OBJECT,properties:{reasoning:{type:m.STRING},newSelector:{type:m.STRING}},required:["newSelector"]},u=await o.models.generateContent({model:A,contents:{parts:[{text:l},{inlineData:{mimeType:"image/jpeg",data:i}}]},config:{responseMimeType:"application/json",responseSchema:c,temperature:D}}),d=I(u.text);if(!d.newSelector||d.newSelector.trim()===""||d.newSelector===e)throw new Error("AI could not generate a valid new selector.");return{newSelector:d.newSelector.trim()}})}catch(s){return N(s,"Self-Heal")}}async function qe(e,t){try{const r=async a=>{t&&await t(a)};return{selectors:await C(e,async a=>{await r("Capturing page state...");const o=await S();if(!o.models)throw new Error("AI models not initialized");const i=(await v.capture(a.windowId,{format:"jpeg",quality:30})).split(",")[1],l=`You are a web developer expert at removing anti-adblock walls and intrusive banners. Analyze the provided webpage screenshot. 
            Identify the blocking elements. Use a rigorous 3-step process:
            1. find the MODAL (the popup box with text).
            2. find the BACKDROP/OVERLAY (the dark/blurred layer covering the whole screen).
            3. find the ROOT CONTAINER (if they share one).

            If they are siblings, provide BOTH selectors separated by a comma.
            
            CRITICAL INSTRUCTIONS:
            - You MUST return a selector that hits the BACKDROP. 
            - Look for full-screen fixed elements with high z-index (e.g., .modal-backdrop, .overlay, #shadow-root).
            - Prefer BROAD wildcard selectors for stability.
            
            Your goal is to provide:
            - 'overlaySelector': A comma-separated string containing selectors for BOTH the modal and the background overlay.
               Example: ".fc-dialog-container, .fc-ab-root, .MuiBackdrop-root"
            - 'scrollSelector': The element that needs scroll restoration (usually 'body' or 'html').`,c={type:m.OBJECT,properties:{reasoning:{type:m.STRING},overlaySelector:{type:m.STRING},scrollSelector:{type:m.STRING}},required:["overlaySelector"]};await r("Consulting with Gemini AI..."),console.log(`ZenithGuard: Sending prompt to AI for tab ${e}...`);const u=new Promise((f,_)=>setTimeout(()=>_(new Error("AI_TIMEOUT")),4e4)),d=o.models.generateContent({model:A,contents:{parts:[{text:l},{inlineData:{mimeType:"image/jpeg",data:i}}]},config:{responseMimeType:"application/json",responseSchema:c,temperature:D}}),h=await Promise.race([d,u]);console.log(`ZenithGuard: AI response received for tab ${e}.`);const g=I(h.text);if(console.log(`ZenithGuard: AI result for tab ${e}:`,g),!g.overlaySelector||g.overlaySelector.trim()==="")throw new Error("AI could not identify a blocking overlay.");return{overlaySelector:g.overlaySelector.trim(),scrollSelector:g.scrollSelector?.trim()||"body, html"}})}}catch(r){return N(r,"Adblock Wall Defeat")}}async function Je(e){try{return(await chrome.tabs.get(e)).active?await C(e,async s=>{const a=await S();if(!a.models)throw new Error("AI models not initialized");const n=(await v.capture(s.windowId,{format:"jpeg",quality:q})).split(",")[1],i=`Analyze the provided webpage screenshot for a cookie consent banner. Your goal is to find the single button that is best for user privacy. 
            1. Prioritize buttons with text like 'Reject All', 'Deny', 'Decline', 'Necessary Cookies Only', 'Save Preferences' (if options can be deselected), or 'Manage Settings'.
            2. If no rejection option is visible, as a LAST RESORT, find the button to accept and dismiss the banner, like 'Accept All', 'OK', 'Allow', or 'Got it'.
            3. If no cookie banner or relevant button is visible in the screenshot, you MUST return null for the 'selector' and 'action' properties.
            Return a single, robust CSS selector for the identified button and classify your action.
            IMPORTANT: The returned selector must be a standard, valid CSS selector usable by 'document.querySelector()'. DO NOT use non-standard pseudo-classes like ':has-text()' or ':contains()'.`,l={type:m.OBJECT,properties:{reasoning:{type:m.STRING},selector:{type:m.STRING},action:{type:m.STRING}}},c=await a.models.generateContent({model:A,contents:{parts:[{text:i},{inlineData:{mimeType:"image/jpeg",data:n}}]},config:{responseMimeType:"application/json",responseSchema:l,temperature:D}}),u=I(c.text);return!u||!u.selector||u.selector.trim()===""?{result:{selector:null,action:null}}:{result:{selector:u.selector.trim(),action:u.action}}},{requireFocus:!1}):{result:{selector:null,action:null}}}catch(t){const r=t;return r.message&&r.message.includes("could not identify a consent button")?{result:{selector:null,action:null}}:N(t,"Cookie Consent")}}const R="youtube-rules-cache",le=14400*1e3;async function F(e=!1){const{youtubeRulesUrl:t}=await chrome.storage.sync.get("youtubeRulesUrl");if(!t||t.includes("YOUR_USERNAME")){console.warn("ZenithGuard: YouTube rules URL is not configured. Using local fallback. Ad-blocking may be outdated."),await ee(e);return}if(!e){const r=await chrome.storage.local.get(R);if(r[R]&&Date.now()-r[R].lastUpdated<le)return}try{console.log("ZenithGuard: Updating dynamic YouTube ad blocking rules from remote source...");const r=await fetch(t,{signal:AbortSignal.timeout(15e3)});if(!r.ok)throw new Error(`Failed to fetch remote YouTube rules: ${r.statusText}`);const s=await r.json();if(!s.regexFilters&&!s.urlFilters)throw new Error("Fetched rules file is empty or invalid.");await chrome.storage.local.set({[R]:{rules:s,lastUpdated:Date.now()}}),console.log("ZenithGuard: Dynamic YouTube rules updated successfully.")}catch(r){console.error("ZenithGuard: Failed to update dynamic YouTube rules. Using local fallback.",r),await ee(!0)}}async function ee(e=!1){if(!e){const t=await chrome.storage.local.get(R);if(t[R]&&Date.now()-t[R].lastUpdated<le)return}try{const t=chrome.runtime.getURL("rules/youtube_rules.json"),r=await fetch(t);if(!r.ok)throw new Error(`Failed to fetch local YouTube rules: ${r.statusText}`);const s=await r.json();await chrome.storage.local.set({[R]:{rules:s,lastUpdated:Date.now()}})}catch(t){console.error("ZenithGuard: Failed to load local fallback rules.",t)}}const T="tracker-list-cache",Xe=1440*60*1e3;async function H(e=!1){const{trackerListUrl:t}=await chrome.storage.sync.get("trackerListUrl");if(!t||t.includes("YOUR_USERNAME")){console.warn("ZenithGuard: Tracker list URL is not configured. Privacy Insights will be limited to the hard-coded fallback list.");return}if(!e){const r=await chrome.storage.local.get(T);if(r[T]&&Date.now()-r[T].lastUpdated<Xe)return}try{console.log("ZenithGuard: Updating dynamic tracker list...");const r=await fetch(t,{signal:AbortSignal.timeout(15e3)});if(!r.ok)throw new Error(`Failed to fetch remote tracker list: ${r.statusText}`);const s=await r.json();if(!s.SESSION_REPLAY||!s.DATA_BROKER)throw new Error("Fetched tracker list file is invalid.");await chrome.storage.local.set({[T]:{list:s,lastUpdated:Date.now()}}),console.log("ZenithGuard: Dynamic tracker list updated successfully.")}catch(r){console.error("ZenithGuard: Failed to update dynamic tracker list.",r)}}async function ue(){return(await chrome.storage.local.get(T))[T]?.list||null}const p={},Ve=200;function Qe(){chrome.webNavigation.onCommitted.addListener(e=>{e.frameId===0&&(p[e.tabId]=[])}),chrome.declarativeNetRequest.onRuleMatchedDebug&&chrome.declarativeNetRequest.onRuleMatchedDebug.addListener(e=>{const{request:t,rule:r}=e;if(p[t.tabId]){let a=Se(r.ruleId);r.rulesetId&&(a="Static Filter List");const o=p[t.tabId].find(n=>n.url===t.url&&!n.statusUpdated);o&&(o.status="blocked",o.matchedRuleInfo={ruleId:r.ruleId,source:a},o.statusUpdated=!0)}let s="tracker";r.rulesetId?r.rulesetId==="easylist"||r.rulesetId==="ublock_annoyances"?s="ad":r.rulesetId==="easyprivacy"&&(s="tracker"):r.ruleId&&(r.ruleId>=j&&r.ruleId<Z||r.ruleId>=Z&&r.ruleId<6e4?s="tracker":r.ruleId>=5e3&&r.ruleId<6e3&&(s="ad")),t.url.match(/ad|banner|doubleclick|pagead/i)&&(s="ad"),Ce(s,t.type)}),chrome.webRequest.onBeforeRequest.addListener(e=>{p[e.tabId]||(p[e.tabId]=[]),p[e.tabId].find(r=>r.url===e.url)||(p[e.tabId].length>=Ve&&p[e.tabId].shift(),p[e.tabId].push({url:e.url,type:e.type,initiator:e.initiator,timestamp:e.timeStamp,status:"allowed"}))},{urls:["<all_urls>"]}),chrome.tabs.onRemoved.addListener(e=>{p[e]&&delete p[e]})}function Y(e){return p[e]||[]}function et(e){e&&(p[e]=[])}function tt(){chrome.contextMenus.removeAll(()=>{chrome.contextMenus.create({id:"zenithguard-quick-hide",title:"ZenithGuard: Quick Hide Element",contexts:["all"]}),chrome.contextMenus.create({id:"zenithguard-ai-hide-targeted",title:"ZenithGuard: Hide with AI...",contexts:["all"]})})}function rt(){chrome.contextMenus.onClicked.addListener(async(e,t)=>{if(!t||!t.id)return;const s={"zenithguard-quick-hide":"QUICK_HIDE_ELEMENT","zenithguard-ai-hide-targeted":"START_AI_HIDING_TARGETED"}[e.menuItemId];if(s){if(s==="START_AI_HIDING_TARGETED")try{await chrome.scripting.executeScript({target:{tabId:t.id},files:["js/content/ai_hider.js"]})}catch(a){console.error("ZenithGuard: Failed to inject AI Hider script.",a);return}chrome.tabs.sendMessage(t.id,{type:s})}})}const st=["linkedin.com","adobe.com","canva.com","dropbox.com","myfitnesspal.com","zynga.com","twitter.com","wattpad.com","quora.com","tumblr.com","myheritage.com","dubsmash.com","verizon.com","vk.com","last.fm"];function at(e,t){if(!e)return!1;const r=e.split(".").reverse();for(let s=0;s<r.length-1;s++){const a=r.slice(0,s+2).reverse().join(".");if(t.includes(a))return!0}return!1}const k={};function ot(){chrome.tabs.onUpdated.addListener((e,t,r)=>{e&&r.url&&r.url.startsWith("http")&&(k[e]=r.url)}),chrome.tabs.onRemoved.addListener(async e=>{const t=k[e];if(!t){delete k[e];return}try{const{forgetfulSites:r=[]}=await chrome.storage.sync.get("forgetfulSites"),s=(r||[]).filter(o=>o.enabled).map(o=>o.value);if(s.length===0){delete k[e];return}const a=new URL(t).hostname;if(s.includes(a)){console.log(`ZenithGuard: Forgetful Browsing is clearing data for ${a}`);const o=new URL(t).origin;await chrome.browsingData.remove({origins:[o]},{cache:!0,cookies:!0,localStorage:!0,sessionStorage:!0})}}catch(r){console.warn(`ZenithGuard: Error during Forgetful Browsing cleanup for ${t}:`,r.message)}finally{delete k[e]}}),chrome.tabs.onUpdated.addListener(async(e,t,r)=>{if(t.status==="complete"&&r.url&&r.url.startsWith("http")){const{isBreachWarningEnabled:s}=await chrome.storage.sync.get("isBreachWarningEnabled");if(s){const a=new URL(r.url).hostname;at(a,st)&&chrome.tabs.sendMessage(e,{type:"SHOW_BREACH_WARNING",domain:a}).catch(o=>{})}}})}const nt={SESSION_REPLAY:{domains:["hotjar.com","fullstory.com","logrocket.com","inspectlet.com","clarity.ms"],generate:e=>({type:"warning",icon:"record",message:`This site uses session replay scripts from <strong>${e}</strong>, which can record your clicks and keystrokes.`})},DATA_BROKER:{domains:["criteo.com","liveramp.com","acxiom.com","oracle.com","rlcdn.com"],generate:e=>({type:"alert",icon:"database",message:`A connection was made to <strong>${e}</strong>, a known data broker that collects and sells user information.`})},AD_EXCHANGE:{domains:["adnxs.com","rubiconproject.com","openx.net","pubmatic.com","indexexchange.com"],generate:e=>({type:"alert",icon:"megaphone",message:`This site uses the <strong>${e}</strong> ad exchange, which shares your data across a wide network of advertisers.`})}};async function it(e){if(!e||!Array.isArray(e)||e.length===0)return[];let t=await ue(),r=!1;t||(t=nt,r=!0);const s=[],a=new Set,o=new Set;for(const n of e)try{const i=new URL(n.url).hostname;if(n.status==="blocked"&&o.add(i),t)for(const l in t){const c=t[l];for(const u of c.domains)if(i.includes(u)&&!a.has(u)){let d;r?d=c.generate(u):d={type:l==="DATA_BROKER"||l==="AD_EXCHANGE"?"alert":"warning",icon:l==="SESSION_REPLAY"?"record":l==="DATA_BROKER"?"database":"megaphone",message:c.message.replace("{domain}",u)},s.push(d),a.add(u)}}}catch{}return o.size>15&&s.unshift({type:"info",icon:"shield",message:`ZenithGuard blocked requests to <strong>${o.size}</strong> unique tracking domains on this page.`}),s}const U={},ct=2e4;let $;function P(){return new Promise(e=>{$&&clearTimeout($),$=setTimeout(async()=>{await w(),e()},500)})}function lt(){chrome.tabs.onRemoved.addListener(e=>{U[e]&&delete U[e]}),chrome.runtime.onMessage.addListener((e,t,r)=>{const s=ut[e.type];return s?((async()=>{try{const a=await s(e,t);r(a)}catch(a){const o=a.message;o==="QUOTA_EXCEEDED"||o==="TAB_CLOSED"?console.warn(`ZenithGuard: Handled known error in ${e.type}:`,o):console.error(`Error handling message ${e.type}:`,a),r({error:o})}})(),!0):!1})}const ut={TOGGLE_GLOBAL_PROTECTION:async e=>{await chrome.storage.sync.set({isProtectionEnabled:e.data.isEnabled});const t=await chrome.tabs.query({url:["http://*/*","https://*/*"]});for(const r of t)try{r.id&&chrome.tabs.reload(r.id)}catch{}},APPLY_RULES_AND_RELOAD_TAB:async e=>{await P();try{e.data.tabId&&chrome.tabs.reload(e.data.tabId)}catch{}},APPLY_ALL_RULES:()=>P(),ANALYZE_PAGE_WITH_AI:async e=>{const{tabId:t,pageUrl:r}=e.data;if(U[t]&&Date.now()-U[t]<ct)return{error:"Please wait before re-running the analysis."};U[t]=Date.now();const s=Y(t);return We(t,r,s)},HIDE_ELEMENT_WITH_AI:(e,t)=>{if(!(!t.tab||!t.tab.id))return Ze(e.data.description,{...e.data.context,tabId:t.tab.id})},DEFEAT_ADBLOCK_WALL:async e=>{const{tabId:t}=e.data,r=async s=>{try{await chrome.tabs.sendMessage(t,{type:"SHOW_PROCESSING_TOAST",message:s})}catch{}};try{const s=await qe(t,r);if(s.error)return s;if(s.selectors){try{const o=await chrome.webNavigation.getAllFrames({tabId:t});if(o){for(const n of o)chrome.tabs.sendMessage(t,{type:"EXECUTE_ADBLOCK_WALL_FIX",selectors:s.selectors},{frameId:n.frameId}).catch(()=>{});console.log(`ZenithGuard: Broadcasted wall-fix to ${o.length} frames.`)}}catch{chrome.tabs.sendMessage(t,{type:"EXECUTE_ADBLOCK_WALL_FIX",selectors:s.selectors}).catch(()=>{})}const a=await chrome.tabs.get(t);if(a&&a.url){const o=new URL(a.url).hostname,{persistentWallFixes:n={}}=await chrome.storage.sync.get("persistentWallFixes");n[o]={overlaySelector:s.selectors.overlaySelector,scrollSelector:s.selectors.scrollSelector,enabled:!0},await chrome.storage.sync.set({persistentWallFixes:n}),console.log(`ZenithGuard: Persistent fix saved for ${o} from background.`)}}return s}catch(s){throw chrome.tabs.sendMessage(t,{type:"SHOW_ERROR_TOAST",message:s.message}).catch(()=>{}),s}},HANDLE_COOKIE_CONSENT:(e,t)=>{if(!(!t.tab||!t.tab.id))return Je(t.tab.id)},SUMMARIZE_PRIVACY_POLICY:async e=>{const{domain:t,policyUrl:r}=e.data,s=`privacy-summary-${t}`;try{const a=await je(r);if(a.error)throw new Error(a.error);return await chrome.storage.local.set({[s]:{summary:a,timestamp:Date.now()}}),a}catch(a){const o=a.message;return await chrome.storage.local.set({[s]:{error:o,timestamp:Date.now()}}),{error:o}}},SELF_HEAL_RULE:(e,t)=>{if(!(!t.tab||!t.tab.id))return ze(e.data.selector,t.tab.id,e.data.pageUrl)},GET_NETWORK_LOG:(e,t)=>{const r=e.tabId||t.tab?.id;return r?Y(r):[]},CLEAR_NETWORK_LOG:e=>{e.tabId&&et(e.tabId)},ADD_TO_NETWORK_BLOCKLIST:async e=>{const{networkBlocklist:t=[]}=await chrome.storage.sync.get("networkBlocklist"),{domain:r}=e;return r&&!t.some(s=>s.value===r)?(t.push({value:r,enabled:!0}),await chrome.storage.sync.set({networkBlocklist:t}),{success:!0}):{success:!1,message:"Rule already exists."}},BULK_ADD_RULES:async e=>{const{networkBlocklist:t,customHidingRules:r}=e.data,s=await chrome.storage.sync.get(["networkBlocklist","customHidingRules"]),a=new Set((s.networkBlocklist||[]).map(c=>c.value));t.forEach(c=>a.add(c));const o=Array.from(a).map(c=>({value:c,enabled:!0})),n=s.customHidingRules||{},{domain:i,selectors:l}=r;if(i&&l.length>0){const c=new Set((n[i]||[]).map(u=>u.value));l.forEach(u=>c.add(u)),n[i]=Array.from(c).map(u=>({value:u,enabled:!0}))}return await chrome.storage.sync.set({networkBlocklist:o,customHidingRules:n}),{success:!0}},TEMPORARILY_ALLOW_DOMAIN:async e=>{const{domain:t}=e;if(!t)return;const{sessionAllowlist:r=[]}=await chrome.storage.session.get("sessionAllowlist");r.includes(t)||(await chrome.storage.session.set({sessionAllowlist:[...r,t]}),await w())},PAUSE_PROTECTION:async()=>{const e=Date.now()+9e5;return await chrome.storage.session.set({protectionPausedUntil:e}),await chrome.alarms.create("resumeProtection",{delayInMinutes:15}),await w(),{success:!0,pauseUntil:e}},RESUME_PROTECTION:async()=>(await chrome.storage.session.remove("protectionPausedUntil"),await chrome.alarms.clear("resumeProtection"),await w(),{success:!0}),GET_PRIVACY_INSIGHTS:e=>e.tabId?it(Y(e.tabId)):null,START_FOCUS_MODE:async e=>(await be(e.duration),await P(),{success:!0}),STOP_FOCUS_MODE:async()=>(await Ee(),await P(),{success:!0}),GET_HIDING_RULES_FOR_DOMAIN:e=>Me(e.domain),PREVIEW_ELEMENT:async(e,t)=>{if(t.tab&&t.tab.id)try{await chrome.tabs.sendMessage(t.tab.id,e)}catch{}},CLEAR_PREVIEW:async(e,t)=>{if(t.tab&&t.tab.id)try{await chrome.tabs.sendMessage(t.tab.id,e)}catch{}},FOUND_PRIVACY_POLICY_URL:e=>{chrome.storage.local.set({[`privacy-policy-url-${e.data.domain}`]:e.data.policyUrl})},RESET_SETTINGS_TO_DEFAULTS:async()=>(await ve(),{success:!0}),FORCE_UPDATE_ALL_FILTER_LISTS:async()=>(await Promise.all([x(!0),B(),F(!0),H(!0)]),{success:!0}),FORCE_UPDATE_SINGLE_LIST:async e=>{const{filterLists:t=[]}=await chrome.storage.sync.get("filterLists"),r=t.find(s=>s.url===e.url);return r&&(await ce(r),await w()),{success:!0}},REAPPLY_HIDING_RULES:async()=>{(await chrome.tabs.query({url:["http://*/*","https://*/*"],status:"complete"})).forEach(t=>{t.id&&chrome.tabs.sendMessage(t.id,{type:"REAPPLY_HIDING_RULES"}).catch(()=>{})})}};class dt{stats=new Map;trackerCache=null;constructor(){this.loadTrackers()}async loadTrackers(){this.trackerCache=await ue()}resetStats(t){this.stats.set(t,{grade:"A",score:100,trackersBlocked:0,trackersFound:[]}),this.updateBadge(t)}getStats(t){return this.stats.get(t)||{grade:"A",score:100,trackersBlocked:0,trackersFound:[]}}processRequest(t,r){if(this.trackerCache&&r)try{const s=new URL(r).hostname,a=this.categorizeTracker(s);if(a){const o=this.getStats(t);o.trackersFound.some(n=>n.name===s)||(o.trackersFound.push({id:s,name:s,category:a}),o.trackersBlocked++,this.recalculateScore(o),this.stats.set(t,o),this.updateBadge(t))}}catch{}}categorizeTracker(t){for(const[r,s]of Object.entries(this.trackerCache))if(s.domains&&s.domains.some(a=>t.includes(a)))return this.mapCategory(r);return null}mapCategory(t){switch(t){case"ADVERTISING":return"Advertising";case"ANALYTICS":return"Analytics";case"FINGERPRINTING":return"Fingerprinting";case"SESSION_REPLAY":return"Fingerprinting";case"SOCIAL":return"Social";case"CRYPTOMINING":return"Cryptomining";default:return"Unknown"}}recalculateScore(t){let r=100;for(const s of t.trackersFound)switch(s.category){case"Fingerprinting":r-=15;break;case"Cryptomining":r-=20;break;case"Advertising":r-=5;break;case"Analytics":r-=5;break;case"Social":r-=10;break}t.score=Math.max(0,r),t.grade=this.getGrade(t.score)}getGrade(t){return t>=90?"A":t>=80?"B":t>=70?"C":t>=50?"D":"F"}updateBadge(t){const r=this.getStats(t),s={A:"#4ade80",B:"#a3e635",C:"#facc15",D:"#fb923c",F:"#f87171"};chrome.action.setBadgeText({tabId:t,text:r.grade}),chrome.action.setBadgeBackgroundColor({tabId:t,color:s[r.grade]})}}Qe();rt();ot();lt();const J=new dt;chrome.webRequest.onBeforeRequest.addListener(e=>{e.tabId>-1&&e.url&&J.processRequest(e.tabId,e.url)},{urls:["<all_urls>"]});chrome.tabs.onUpdated.addListener((e,t,r)=>{t.status==="loading"&&J.resetStats(e)});chrome.runtime.onMessage.addListener((e,t,r)=>{if(e.type==="GET_PRIVACY_STATS"){const s=J.getStats(e.tabId);return r(s),!0}return!1});chrome.runtime.onInstalled.addListener(async e=>{if(await ie(),e.reason==="install")chrome.tabs.create({url:"src/pages/welcome.html"});else if(e.reason==="update"){const t=chrome.runtime.getManifest().version;e.previousVersion!==t&&chrome.tabs.create({url:`src/pages/whats_new.html?v=${t}`})}tt(),await De(),await w(),await x(!0),await B(),await F(!0),await H(!0),chrome.alarms.create("dailyListUpdate",{periodInMinutes:1440})});chrome.runtime.onStartup.addListener(async()=>{await ie(),await w(),await x(),await B(),await F(),await H()});chrome.storage.onChanged.addListener(async(e,t)=>{if(t!=="sync")return;if(e.geminiApiKey&&$e(),(e.isFocusModeEnabled||e.focusModeUntil||e.focusBlocklist)&&await w(),["networkBlocklist","customHidingRules","heuristicKeywords","defaultBlocklist","disabledSites","isolationModeSites","filterLists","isHeuristicEngineEnabled","isUrlCleanerEnabled","isMalwareProtectionEnabled","isYouTubeAdBlockingEnabled","isProtectionEnabled","enabledStaticRulesets","forgetfulSites"].some(s=>e[s])){console.log("ZenithGuard: Rule-related setting changed. Re-applying all rules."),await w();const a=(await chrome.tabs.query({url:["http://*/*","https://*/*"],status:"complete"})).map(o=>o.id?chrome.tabs.sendMessage(o.id,{type:"REAPPLY_HIDING_RULES"}).catch(n=>{}):Promise.resolve());await Promise.allSettled(a)}});chrome.alarms.onAlarm.addListener(async e=>{e.name==="dailyListUpdate"&&(await x(),await B(),await F(),await H()),e.name==="resumeProtection"&&(await chrome.storage.session.remove("protectionPausedUntil"),await w(),await chrome.alarms.clear("resumeProtection"))});chrome.commands.onCommand.addListener(async e=>{if(e==="open-settings")chrome.runtime.openOptionsPage();else if(e==="open-logger"){const r=(await chrome.tabs.query({active:!0,currentWindow:!0}))[0]?.id,s=r?`src/pages/logger.html?tabId=${r}`:"src/pages/logger.html";chrome.tabs.create({url:s})}else if(e==="toggle-zapper"){const t=await chrome.tabs.query({active:!0,currentWindow:!0});if(t.length>0&&t[0].id)try{await chrome.tabs.sendMessage(t[0].id,{type:"START_ZAPPER_MODE"})}catch(r){console.warn("ZenithGuard: Could not toggle Zapper on this tab. Content script may not be loaded.",r)}}});
