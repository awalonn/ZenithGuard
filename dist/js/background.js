import{B as F}from"./subscription_presets-DdBWjbH6.js";const U=["utm_source","utm_medium","utm_campaign","utm_term","utm_content","fbclid","fbc","gclid","gclsrc","dclid","_hsenc","_hsmi","hsCtaTracking","mkt_tok","mc_cid","mc_eid","vero_id","yclid","_openstat","rb_clickid","s_cid"];function re(e,t){if(!U.length)return[];const a=[];let r=e;const s=15;for(let o=0;o<U.length;o+=s){const i=`[?&](${U.slice(o,o+s).join("|")})=`,l={id:r++,priority:1,action:{type:"redirect",redirect:{transform:{queryTransform:{removeParams:U}}}},condition:{regexFilter:i,resourceTypes:["main_frame","sub_frame"]}};a.push(l)}return a}const se="https://raw.githubusercontent.com/StevenBlack/hosts/master/hosts",B="malware-list-cache";async function N(){try{console.log("ZenithGuard: Updating malware domain list...");const e=await fetch(se,{signal:AbortSignal.timeout(3e4)});if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const t=await e.text(),a=oe(t);await chrome.storage.local.set({[B]:{domains:a,lastUpdated:Date.now()}}),console.log(`ZenithGuard: Malware list updated with ${a.length} domains.`)}catch(e){console.error("ZenithGuard: Failed to update malware list.",e)}}function oe(e){const t=new Set,a=e.split(`
`);for(const r of a){const s=r.trim();if(s.startsWith("#")||!s)continue;const o=s.split(/\s+/);if(o.length>=2&&(o[0]==="0.0.0.0"||o[0]==="127.0.0.1")){const c=o[1];c&&c.includes(".")&&c!=="localhost"&&t.add(c)}}return Array.from(t)}async function ne(e,t,a){const s=(await chrome.storage.local.get(B))[B]?.domains;if(!s||s.length===0)return[];const o=[],c=chrome.runtime.getURL("pages/blocked.html"),i=4e3;for(let l=0;l<s.length;l+=i){if(o.length>=a){console.warn(`ZenithGuard: Malware protection rule budget (${a}) reached. Not all malware domains will be loaded.`);break}const n=s.slice(l,l+i);o.push({id:e+o.length,priority:1,action:{type:"redirect",redirect:{url:c}},condition:{requestDomains:n,resourceTypes:["main_frame"],excludedInitiatorDomains:t.length>0?t:void 0}})}return o}const p="youtube-rules-cache",K=14400*1e3;async function O(e=!1){const{youtubeRulesUrl:t}=await chrome.storage.sync.get("youtubeRulesUrl");if(!t||t.includes("YOUR_USERNAME")){console.warn("ZenithGuard: YouTube rules URL is not configured. Using local fallback. Ad-blocking may be outdated."),await j(e);return}if(!e){const a=await chrome.storage.local.get(p);if(a[p]&&Date.now()-a[p].lastUpdated<K)return}try{console.log("ZenithGuard: Updating dynamic YouTube ad blocking rules from remote source...");const a=await fetch(t,{signal:AbortSignal.timeout(15e3)});if(!a.ok)throw new Error(`Failed to fetch remote YouTube rules: ${a.statusText}`);const r=await a.json();if(!r.regexFilters&&!r.urlFilters)throw new Error("Fetched rules file is empty or invalid.");await chrome.storage.local.set({[p]:{rules:r,lastUpdated:Date.now()}}),console.log("ZenithGuard: Dynamic YouTube rules updated successfully.")}catch(a){console.error("ZenithGuard: Failed to update dynamic YouTube rules. Using local fallback.",a),await j(!0)}}async function j(e=!1){if(!e){const t=await chrome.storage.local.get(p);if(t[p]&&Date.Now()-t[p].lastUpdated<K)return}try{const t=chrome.runtime.getURL("rules/youtube_rules.json"),a=await fetch(t);if(!a.ok)throw new Error(`Failed to fetch local YouTube rules: ${a.statusText}`);const r=await a.json();await chrome.storage.local.set({[p]:{rules:r,lastUpdated:Date.now()}})}catch(t){console.error("ZenithGuard: Failed to load local fallback rules.",t)}}async function ie(){return(await chrome.storage.local.get(p))[p]?.rules||null}const H=100,q=1e3,b=5e3,z=6e3,J=15e3,Y=18e3,C=2e4,Q=6e4,X=8e4,Z=128,ce=20;let v=!1;function le(e){if(e>=X)return"Default Blocklist";if(e>=Q)return"User Allowlist";if(e>=C)return"Filter List";if(e>=Y)return"Malware Protection";if(e>=J)return"URL Cleaner";if(e>=z)return"Isolation Mode";if(e>=b)return"YouTube Ads";if(e>=q)return"Network Blocklist";if(e>=H)return"Heuristic Engine";const t=F.find(a=>a.id===e);return t?t.name:"Unknown"}function ue(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}async function f(){if(v){console.log("ZenithGuard: Rule application already in progress.");return}v=!0;try{const t=(await chrome.declarativeNetRequest.getDynamicRules()).map(h=>h.id),a=await chrome.storage.sync.get(["isHeuristicEngineEnabled","heuristicKeywords","heuristicAllowlist","networkBlocklist","defaultBlocklist","disabledSites","isUrlCleanerEnabled","isMalwareProtectionEnabled","isolationModeSites","isYouTubeAdBlockingEnabled","filterLists","enabledStaticRulesets","isProtectionEnabled"]),{isProtectionEnabled:r=!0}=a,{protectionPausedUntil:s}=await chrome.storage.session.get("protectionPausedUntil"),o=s&&s>Date.now(),c=F.map(h=>h.id);if(!r||o){t.length>0&&await chrome.declarativeNetRequest.updateDynamicRules({removeRuleIds:t}),await chrome.declarativeNetRequest.updateEnabledRulesets({disableRulesetIds:c}),console.log(o?"ZenithGuard: Protection paused. All rules disabled.":"ZenithGuard: Protection globally disabled. All rules disabled."),v=!1;return}let i=[];const l=a.enabledStaticRulesets||c;await chrome.declarativeNetRequest.updateEnabledRulesets({enableRulesetIds:l,disableRulesetIds:c.filter(h=>!l.includes(h))});const n=a.disabledSites||[];if(n.length>0){let h=Q;const y=[];for(const D of n)y.push({id:h++,priority:5,action:{type:"allow"},condition:{requestDomains:[D],resourceTypes:["main_frame","sub_frame","script","xmlhttprequest","image","media","stylesheet","other"]}}),y.push({id:h++,priority:5,action:{type:"allow"},condition:{initiatorDomains:[D],resourceTypes:["main_frame","sub_frame","script","xmlhttprequest","image","media","stylesheet","other"]}});i.push(...y)}let m=(chrome.declarativeNetRequest.MAX_NUMBER_OF_DYNAMIC_RULES||5e3)-i.length;const w=[await fe(a),me(a.isolationModeSites),a.isHeuristicEngineEnabled?he(a.heuristicKeywords,a.heuristicAllowlist):[],ge(a.defaultBlocklist),pe(a.networkBlocklist),a.isUrlCleanerEnabled?re(J):[]];for(const h of w)i.push(...h);if(m=Math.max(0,m-i.length),a.isMalwareProtectionEnabled&&m>0){const h=await ne(Y,m);i.push(...h),m=Math.max(0,m-h.length)}if(m>0){const h=await de(a.filterLists,m);i.push(...h)}(t.length>0||i.length>0)&&await chrome.declarativeNetRequest.updateDynamicRules({removeRuleIds:t,addRules:i})}catch(e){console.error("ZenithGuard: Failed to apply dynamic rules.",e)}finally{v=!1}}async function de(e,t){const a=new Set,s=(e||[]).filter(n=>n.status==="success"&&n.enabled);if(s.length===0)return[];const o=s.map(n=>`filterlist-${n.url}`),c=await chrome.storage.local.get(o);for(const n of o)c[n]&&c[n].networkRules&&c[n].networkRules.forEach(u=>a.add(u));if(a.size===0)return[];const i=[];let l=C;for(const n of a){if(i.length>=t){console.warn(`ZenithGuard: *Custom* filter list rule budget (${t}) reached. Some rules were not added.`);break}n.length>0&&i.push({id:l++,priority:3,action:{type:"block"},condition:{urlFilter:n,resourceTypes:["main_frame","sub_frame","script","xmlhttprequest","image","media","websocket"]}})}return i}function me(e){return e?e.filter(t=>t.enabled).map((t,a)=>({id:z+a,priority:1,action:{type:"block"},condition:{initiatorDomains:[t.value],domainType:"thirdParty",resourceTypes:["script","object","sub_frame"]}})):[]}function he(e,t){const a=[];if(!e||e.length===0)return a;const r=e.filter(n=>n.enabled).map(n=>ue(n.value));if(r.length===0)return a;const s=(t||[]).filter(n=>n.enabled).map(n=>n.value),o=s.length>0?s:void 0;let c=[],i=0,l=0;for(const n of r){if(n.length>Z){console.warn(`ZenithGuard: Heuristic keyword starting with "${n.substring(0,50)}..." is too long and will be skipped.`);continue}const u=i>0&&i+n.length+1>Z,m=c.length>=ce;u||m?(a.push({id:H+l++,priority:2,action:{type:"block"},condition:{regexFilter:c.join("|"),resourceTypes:["main_frame","sub_frame","script","xmlhttprequest"],excludedInitiatorDomains:o}}),c=[n],i=n.length):(i>0&&(i+=1),c.push(n),i+=n.length)}return c.length>0&&a.push({id:H+l,priority:2,action:{type:"block"},condition:{regexFilter:c.join("|"),resourceTypes:["main_frame","sub_frame","script","xmlhttprequest"],excludedInitiatorDomains:o}}),a}function ge(e){return e?e.filter(t=>t.enabled).map((t,a)=>{const s=t.value.startsWith("/")&&(t.value.endsWith("/")||t.value.endsWith("/i"))?{regexFilter:t.value.slice(1,-1),resourceTypes:["main_frame","sub_frame","script","xmlhttprequest"]}:{urlFilter:t.value,resourceTypes:["main_frame","sub_frame","script","xmlhttprequest","image","media","websocket","other"]};return{id:X+a,priority:2,action:{type:"block"},condition:s}}):[]}function pe(e){return e?e.filter(t=>t.enabled).map((t,a)=>({id:q+a,priority:1,action:{type:"block"},condition:{urlFilter:`||${t.value}^`,resourceTypes:["main_frame","sub_frame","script","xmlhttprequest","image","media","websocket","other"]}})):[]}async function fe(e){if(!e.isYouTubeAdBlockingEnabled)return[];const t=["youtube.com","m.youtube.com","music.youtube.com"];let a=[{id:b,priority:1,action:{type:"block"},condition:{urlFilter:"||youtube.com/api/stats/ads",initiatorDomains:t,resourceTypes:["xmlhttprequest"]}},{id:b+1,priority:1,action:{type:"block"},condition:{urlFilter:"||googleads.g.doubleclick.net^",initiatorDomains:t,resourceTypes:["xmlhttprequest","sub_frame","script"]}},{id:b+2,priority:1,action:{type:"block"},condition:{urlFilter:"||googlesyndication.com^",initiatorDomains:t,resourceTypes:["xmlhttprequest","sub_frame","script"]}},{id:b+3,priority:1,action:{type:"block"},condition:{regexFilter:"googlevideo\\.com/videoplayback.*(&adformat=|&prev_ad_id=)",resourceTypes:["xmlhttprequest","media"]}}];const r=await ie();if(r){let s=b+100;r.regexFilters&&a.push(...r.regexFilters.map(o=>({id:s++,priority:1,action:{type:"block"},condition:{regexFilter:o,initiatorDomains:t,resourceTypes:["xmlhttprequest","media","script"]}}))),r.urlFilters&&a.push(...r.urlFilters.map(o=>({id:s++,priority:1,action:{type:"block"},condition:{urlFilter:o,initiatorDomains:t,resourceTypes:["xmlhttprequest","sub_frame","script"]}})))}return a}const V=["/ads/","-ads-","_ads_","/advert/","adserver.","adservice.","ad-delivery","third-party-ads","/track.js","/tracking.","/beacon.","/pixel.","/collect?","analytics.js","metrics.","track.gif"],ee=[{value:"||doubleclick.net^",enabled:!0},{value:"||google-analytics.com^",enabled:!0},{value:"||googletagmanager.com^",enabled:!0},{value:"||googlesyndication.com^",enabled:!0},{value:"||facebook.net^",enabled:!0},{value:"||connect.facebook.net^",enabled:!0},{value:"||criteo.com^",enabled:!0},{value:"||adroll.com^",enabled:!0},{value:"||rubiconproject.com^",enabled:!0},{value:"||outbrain.com^",enabled:!0},{value:"||taboola.com^",enabled:!0},{value:"||scorecardresearch.com^",enabled:!0},{value:"||quantserve.com^",enabled:!0},{value:"||hotjar.com^",enabled:!0},{value:"||mixpanel.com^",enabled:!0},{value:"||segment.com^",enabled:!0},{value:"||optimizely.com^",enabled:!0},{value:"||crazyegg.com^",enabled:!0},{value:"||adnxs.com^",enabled:!0},{value:"||pubmatic.com^",enabled:!0},{value:"adservice.",enabled:!0},{value:"adserver.",enabled:!0},{value:"pagead/",enabled:!0},{value:"prebid.",enabled:!0},{value:"/ad-logic.",enabled:!0},{value:"/ad-delivery/",enabled:!0},{value:"/ads/banner.",enabled:!0},{value:"/ads/preroll.",enabled:!0}];async function ye(){const e=["networkBlocklist","heuristicKeywords","heuristicAllowlist","isolationModeSites","forgetfulSites"],t=await chrome.storage.sync.get(e);let a=!1;for(const l of e)t[l]&&Array.isArray(t[l])&&t[l].length>0&&typeof t[l][0]=="string"&&(console.log(`ZenithGuard: Migrating old rule format for "${l}"...`),t[l]=t[l].map(n=>({value:n,enabled:!0})),a=!0);const{customHidingRules:r={}}=await chrome.storage.sync.get("customHidingRules");let s=!1;for(const l in r)Array.isArray(r[l])&&r[l].length>0&&typeof r[l][0]=="string"&&(r[l]=r[l].map(n=>({value:n,enabled:!0})),s=!0);const o=[];a&&o.push(chrome.storage.sync.set(t)),s&&o.push(chrome.storage.sync.set({customHidingRules:r}));const c=await chrome.storage.sync.get(["trackerListUrl","youtubeRulesUrl"]);let i=!1;c.trackerListUrl&&c.trackerListUrl.includes("YOUR_USERNAME")&&(c.trackerListUrl="https://gist.githubusercontent.com/awalonn/6d72d652200fe4aa16fd7cba3c47e573/raw/c39c25acc9ca31f99f1ae6dbc792024263b5e2c7/trackers.json",i=!0),c.youtubeRulesUrl&&c.youtubeRulesUrl.includes("YOUR_USERNAME")&&(c.youtubeRulesUrl="https://gist.githubusercontent.com/awalonn/446737a854b3b3016b6b4ab9bd35e32b/raw/29c7e5c4bdb9b8f3381f14d585005fde328725d4/youtube_rules.json",i=!0),i&&o.push(chrome.storage.sync.set(c)),o.length>0&&(await Promise.all(o),console.log("ZenithGuard: Rule migration complete."))}async function we(){await chrome.storage.sync.set({defaultBlocklist:ee.map(e=>({value:e.value,enabled:e.enabled})),heuristicKeywords:V.map(e=>({value:e,enabled:!0})),networkBlocklist:[],customHidingRules:{},heuristicAllowlist:[],isolationModeSites:[],youtubeRulesUrl:"https://gist.githubusercontent.com/awalonn/446737a854b3b3016b6b4ab9bd35e32b/raw/29c7e5c4bdb9b8f3381f14d585005fde328725d4/youtube_rules.json",trackerListUrl:"https://gist.githubusercontent.com/awalonn/6d72d652200fe4aa16fd7cba3c47e573/raw/c39c25acc9ca31f99f1ae6dbc792024263b5e2c7/trackers.json"})}async function te(){const{settingsInitialized:e}=await chrome.storage.sync.get("settingsInitialized");e||(console.log("ZenithGuard: First run or settings missing. Initializing default settings."),await chrome.storage.sync.set({isHeuristicEngineEnabled:!0,isUrlCleanerEnabled:!0,isMalwareProtectionEnabled:!0,isYouTubeAdBlockingEnabled:!0,isSandboxedIframeEnabled:!0,isCookieBannerHidingEnabled:!0,isSelfHealingEnabled:!0,isPerformanceModeEnabled:!1,isBreachWarningEnabled:!0,theme:"dark",isProtectionEnabled:!0,filterLists:[{url:"https://easylist.to/easylist/easylist.txt",enabled:!0,status:"new"}],defaultBlocklist:ee.map(t=>({value:t.value,enabled:t.enabled})),heuristicKeywords:V.map(t=>({value:t,enabled:!0})),networkBlocklist:[],customHidingRules:{},heuristicAllowlist:[],isolationModeSites:[],forgetfulSites:[],youtubeRulesUrl:"https://gist.githubusercontent.com/awalonn/446737a854b3b3016b6b4ab9bd35e32b/raw/29c7e5c4bdb9b8f3381f14d585005fde328725d4/youtube_rules.json",trackerListUrl:"https://gist.githubusercontent.com/awalonn/6d72d652200fe4aa16fd7cba3c47e573/raw/c39c25acc9ca31f99f1ae6dbc792024263b5e2c7/trackers.json",settingsInitialized:!0}))}async function be(e,t){const a=new Date().toISOString().slice(0,10),{dailyBlocks:r={},dailyPerformance:s={}}=await chrome.storage.local.get(["dailyBlocks","dailyPerformance"]);r[a]||(r[a]={ads:0,trackers:0}),e==="ad"?r[a].ads=(r[a].ads||0)+1:e==="tracker"&&(r[a].trackers=(r[a].trackers||0)+1),s[a]||(s[a]={totalWeight:0,blockedWeight:0});const c=({image:150,media:1500,script:50,sub_frame:300,xmlhttprequest:10,websocket:5,font:30,stylesheet:20,other:10}[t]||10)*1024;s[a].blockedWeight+=c,s[a].totalWeight+=c*10;const i=Object.keys(r).sort();i.length>30&&i.slice(0,i.length-30).forEach(n=>{delete r[n],delete s[n]}),await chrome.storage.local.set({dailyBlocks:r,dailyPerformance:s})}const Ee=1440*60*1e3;function Re(e){const t=new Set,a={},r=e.split(`
`);for(const s of r){const o=s.trim();if(!(!o||o.startsWith("!")||o.startsWith("[")))if(o.includes("##")){const c=o.split("##"),i=c[0].split(",").filter(n=>n&&!n.startsWith("~")),l=c[1];if(i.length>0)for(const n of i)a[n]||(a[n]=[]),a[n].push(l);else a[""]||(a[""]=[]),a[""].push(l)}else{if(o.startsWith("@@"))continue;t.add(o)}}return{networkRules:Array.from(t),cosmeticRules:a}}async function G(e=!1){const{filterLists:t=[]}=await chrome.storage.sync.get("filterLists"),a=[];for(const r of t){if(!r.enabled)continue;const s=`filterlist-${r.url}`;if(!e){const o=await chrome.storage.local.get(s);if(o[s]&&Date.now()-o[s].lastUpdated<Ee)continue}a.push(ae(r))}a.length>0&&(console.log(`ZenithGuard: Updating ${a.length} *custom* filter list(s)...`),await Promise.all(a),console.log("ZenithGuard: Custom filter list update complete."),await f())}async function ae(e){const{filterLists:t=[]}=await chrome.storage.sync.get("filterLists"),a=r=>r.url===e.url;try{const r=t.find(a);r&&(r.status="updating",await chrome.storage.sync.set({filterLists:t}));const s=await fetch(e.url,{signal:AbortSignal.timeout(6e4)});if(!s.ok)throw new Error(`HTTP error! status: ${s.status}`);const o=await s.text(),{networkRules:c,cosmeticRules:i}=Re(o);if(c.length===0&&Object.keys(i).length===0)throw new Error("Parsing resulted in empty rule sets. The list might be unavailable or invalid.");const l=`filterlist-${e.url}`;await chrome.storage.local.set({[l]:{networkRules:c,cosmeticRules:i,lastUpdated:Date.now()}});const n=(await chrome.storage.sync.get("filterLists")).filterLists||[],u=n.find(a);u&&(u.status="success",u.ruleCount=c.length+Object.values(i).reduce((m,w)=>m+w.length,0),u.lastUpdated=Date.now(),await chrome.storage.sync.set({filterLists:n}))}catch(r){console.error(`ZenithGuard: Failed to update filter list ${e.url}.`,r);const s=(await chrome.storage.sync.get("filterLists")).filterLists||[],o=s.find(a);o&&(o.status="error",await chrome.storage.sync.set({filterLists:s}))}}async function Ae(e){const{filterLists:t=[],isPerformanceModeEnabled:a,disabledSites:r=[]}=await chrome.storage.sync.get(["filterLists","isPerformanceModeEnabled","disabledSites"]);if(a||r.includes(e))return{rules:[]};let s=[];try{const c=await chrome.declarativeNetRequest.getEnabledRulesets();for(const i of F)if(c.includes(i.id)){const l=chrome.runtime.getURL(i.cosmeticRulesUrl),u=await(await fetch(l)).json();if(u){const m=(u[e]||[]).concat(u[""]||[]);s.push(...m)}}}catch(c){console.error("ZenithGuard: Failed to load bundled cosmetic rules.",c)}const o=(t||[]).filter(c=>c.enabled&&c.status==="success");for(const c of o){const i=`filterlist-${c.url}`,n=(await chrome.storage.local.get(i))[i]?.cosmeticRules;if(n){const u=(n[e]||[]).concat(n[""]||[]);s.push(...u)}}return{rules:s.map(c=>({value:c,enabled:!0}))}}const Te="https://generativelanguage.googleapis.com/v1beta/models";var d;(function(e){e.TYPE_UNSPECIFIED="TYPE_UNSPECIFIED",e.STRING="STRING",e.NUMBER="NUMBER",e.INTEGER="INTEGER",e.BOOLEAN="BOOLEAN",e.ARRAY="ARRAY",e.OBJECT="OBJECT",e.NULL="NULL"})(d||(d={}));class _e{constructor(t){if(!t||!t.apiKey)throw new Error("API key is required for GoogleGenAI client.");this.apiKey=t.apiKey,this.models={generateContent:this.generateContent.bind(this)}}async generateContent(t){if(!t.model)throw new Error("Model name is required.");const a=t.model==="gemini-2.5-flash"?"gemini-2.5-flash-preview-09-2025":t.model,r=`${Te}/${a}:generateContent?key=${this.apiKey}`,s={contents:Array.isArray(t.contents)?t.contents:[t.contents]};t.config&&(s.generationConfig={temperature:t.config.temperature,responseMimeType:t.config.responseMimeType,responseSchema:t.config.responseSchema}),t.systemInstruction&&(s.systemInstruction=t.systemInstruction);const o=3;for(let c=0;c<o;c++)try{const i=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(!i.ok){let u;try{u=await i.json()}catch{throw new Error(`HTTP error ${i.status}: ${i.statusText}`)}const m=u?.error?.message||JSON.stringify(u);if(i.status===429||m.toLowerCase().includes("quota"))throw new Error("QUOTA_EXCEEDED");if(i.status>=500&&c<o-1){const h=Math.pow(2,c)*1e3+Math.random()*1e3;await new Promise(y=>setTimeout(y,h));continue}throw new Error(m)}return{text:(await i.json()).candidates?.[0]?.content?.parts?.[0]?.text||""}}catch(i){if(i.name==="AbortError")throw console.error("Gemini API request timed out."),new Error("API request timed out.");if(i.message==="QUOTA_EXCEEDED")throw console.warn("Gemini API quota exceeded."),i;if(c===o-1)throw console.error("Error calling Gemini API after all retries:",i.message),i}throw new Error("Gemini API request failed after all retries.")}}const R="gemini-2.5-flash",Se=50,W=20,Ie=50,ke=200,k=.1;let S=null;function Le(){S=null}async function A(){if(S)return S;const{geminiApiKey:e}=await chrome.storage.sync.get("geminiApiKey");if(!e)throw new Error("Gemini API key is not set. Please set it in the extension settings.");return S=new _e({apiKey:e}),S}async function L(e,t){let a;try{a=await chrome.tabs.get(e)}catch{throw new Error(`Target tab with ID ${e} not found. It may have been closed.`)}if(a.url.startsWith("chrome:")||a.url.startsWith("edge:")||a.url.startsWith("about:")||a.url.startsWith("mozilla:")||a.url.startsWith("view-source:"))throw new Error(`Cannot capture restricted page: ${a.url}`);if(a.url.startsWith("file:")&&!await chrome.extension.isAllowedFileSchemeAccess())throw new Error("File access not enabled. Please enable 'Allow access to file URLs' in extension settings.");try{await chrome.windows.update(a.windowId,{focused:!0}),await chrome.tabs.update(e,{active:!0})}catch(r){throw String(r.message).includes("Tabs cannot be edited right now")?new Error("Action aborted: User is interacting with the tab strip."):r}await new Promise(r=>setTimeout(r,500));try{await chrome.tabs.get(e)}catch{throw new Error("The target tab was closed before the action could complete.")}return await t(a)}async function De(e,t,a){try{const r=await L(e,async l=>{const n=await A(),m=(await chrome.tabs.captureVisibleTab(l.windowId,{format:"jpeg",quality:Se})).split(",")[1],w=(a||[]).filter(T=>T.status==="blocked"&&(T.type==="script"||T.type==="xmlhttprequest")).map(T=>T.url.substring(0,ke)).slice(0,Ie),h=`Analyze the provided webpage screenshot and network log for privacy threats, visual annoyances, and manipulative "dark patterns".
            - Network log contains blocked third-party tracking scripts.
            - The user wants to block ads, trackers, popups, and other intrusive elements.
            - Identify distinct visual elements that are likely ads, banners, or annoyances. For each, provide a UNIQUE and ROBUST CSS selector.
            - Identify network requests that are clearly for tracking or advertising.
            - Identify network requests that match common heuristic patterns for tracking (e.g., contains '/track.js', 'analytics', '/beacon').
            - Identify manipulative UI "dark patterns" like Confirm-shaming (e.g., "No, I don't want to save money"), Roach Motel (easy to sign up, hard to cancel), Hidden Costs, or forced continuity.
            - Be concise. Focus on actionable items. Do not suggest blocking core site functionality.`,y={type:d.OBJECT,properties:{networkThreats:{type:d.ARRAY,items:{type:d.OBJECT,properties:{url:{type:d.STRING},category:{type:d.STRING},reason:{type:d.STRING}}}},visualAnnoyances:{type:d.ARRAY,items:{type:d.OBJECT,properties:{description:{type:d.STRING},suggestedSelector:{type:d.STRING}}}},heuristicMatches:{type:d.ARRAY,items:{type:d.OBJECT,properties:{url:{type:d.STRING},keyword:{type:d.STRING}}}},darkPatterns:{type:d.ARRAY,description:"Deceptive UI patterns designed to trick users.",items:{type:d.OBJECT,properties:{patternName:{type:d.STRING},description:{type:d.STRING}}}}}},D=await n.models.generateContent({model:R,contents:{parts:[{text:h},{inlineData:{mimeType:"image/jpeg",data:m}},{text:`Network Log:
${w.join(`
`)}`}]},config:{responseMimeType:"application/json",responseSchema:y,temperature:k}});return JSON.parse(D.text)}),{auditHistory:s=[]}=await chrome.storage.local.get("auditHistory"),o=(r.networkThreats?.length||0)+(r.visualAnnoyances?.length||0)+(r.heuristicMatches?.length||0)+(r.darkPatterns?.length||0),c=o===0?"A":o<=5?"B":o<=10?"C":"D";let i="unknown";try{i=new URL(t).hostname}catch{console.warn("ZenithGuard: Invalid URL for audit history:",t)}return s.unshift({url:t,domain:i,date:Date.now(),grade:c,threatCount:o}),s.length>50&&s.pop(),await chrome.storage.local.set({auditHistory:s}),await chrome.storage.local.set({[`ai-scan-cache-${t}`]:{data:r,timestamp:Date.now()}}),{result:r}}catch(r){return r.message==="QUOTA_EXCEEDED"?(console.warn("ZenithGuard AI: Quota exceeded."),{error:"QUOTA_EXCEEDED"}):(console.error("ZenithGuard AI Analyzer Error:",r.message),{error:r.message})}}async function Ue(e,t){try{return await L(t.tabId,async r=>{const s=await A(),c=(await chrome.tabs.captureVisibleTab(r.windowId,{format:"jpeg",quality:W})).split(",")[1];let i=`Analyze the provided webpage screenshot. The user wants to hide an element they've described as: "${e}". Based on this description and the visual context of the screenshot, generate the most robust and specific CSS selector possible to uniquely identify and hide this element.`;t&&t.tag&&(i+=` The user initially clicked on a <${t.tag}> element`,t.text&&(i+=` containing text like "${t.text}".`),t.classes&&(i+=` with classes "${t.classes}".`));const l={type:d.OBJECT,properties:{reasoning:{type:d.STRING},selector:{type:d.STRING}}},n=await s.models.generateContent({model:R,contents:{parts:[{text:i},{inlineData:{mimeType:"image/jpeg",data:c}}]},config:{responseMimeType:"application/json",responseSchema:l,temperature:k}}),u=JSON.parse(n.text);if(!u.selector||u.selector.trim()==="")throw new Error("AI failed to generate a valid selector.");return{selector:u.selector.trim()}})}catch(a){return a.message==="QUOTA_EXCEEDED"?(console.warn("ZenithGuard AI: Quota exceeded."),{error:"QUOTA_EXCEEDED"}):(console.error("ZenithGuard AI Hider Error:",a.message),{error:a.message})}}async function ve(e){try{const t=await A(),a=await fetch(e,{signal:AbortSignal.timeout(15e3)});if(!a.ok)throw new Error("Could not fetch the policy page.");const r=await a.text(),s=`You are a privacy expert. Analyze the text from this privacy policy and provide a brief, easy-to-understand summary. Extract key data points. Respond ONLY with the JSON object.
        - "summary": A single, concise sentence (max 25 words) summarizing their main data practice (e.g., "Collects usage data to personalize ads and shares it with partners.").
        - "dataCollected": An array of strings categorizing the data they collect (e.g., "Personal Info", "Location", "Usage Data", "Contact Info", "Financial Info").
        - "sharedWith": An array of strings describing who they share data with (e.g., "Advertisers", "Affiliates", "Law Enforcement", "Analytics Partners").`,o={type:d.OBJECT,properties:{summary:{type:d.STRING},dataCollected:{type:d.ARRAY,items:{type:d.STRING}},sharedWith:{type:d.ARRAY,items:{type:d.STRING}}},required:["summary","dataCollected","sharedWith"]},c=await t.models.generateContent({model:R,contents:{parts:[{text:`Privacy Policy Text:

${r}`}]},systemInstruction:{parts:[{text:s}]},config:{responseMimeType:"application/json",responseSchema:o,temperature:0}});return JSON.parse(c.text)}catch(t){return console.error("ZenithGuard: Failed to summarize privacy policy:",t),{error:t.message}}}async function Ce(e,t,a){try{return await L(t,async s=>{const o=await A(),i=(await chrome.tabs.captureVisibleTab(s.windowId,{format:"jpeg",quality:W})).split(",")[1],l=`On the webpage at ${a}, the following CSS selector was used to hide an unwanted element, but it no longer works: "${e}". 
            Based on the screenshot, analyze the page and generate a NEW, robust CSS selector that targets the element this old selector was most likely trying to hide.
            The element is probably an ad, a banner, a newsletter signup, or a similar annoyance. Prioritize stable attributes.`,n={type:d.OBJECT,properties:{reasoning:{type:d.STRING},newSelector:{type:d.STRING}},required:["newSelector"]},u=await o.models.generateContent({model:R,contents:{parts:[{text:l},{inlineData:{mimeType:"image/jpeg",data:i}}]},config:{responseMimeType:"application/json",responseSchema:n,temperature:k}}),m=JSON.parse(u.text);if(!m.newSelector||m.newSelector.trim()===""||m.newSelector===e)throw new Error("AI could not generate a valid new selector.");return{newSelector:m.newSelector.trim()}})}catch(r){return r.message==="QUOTA_EXCEEDED"?(console.warn("ZenithGuard AI: Quota exceeded."),{error:"QUOTA_EXCEEDED"}):(console.error("ZenithGuard Self-Heal Error:",r.message),{error:r.message})}}async function Ne(e,t){try{const a=async s=>{t&&await t(s)};return{selectors:await L(e,async s=>{await a("Capturing page state...");const o=await A(),i=(await chrome.tabs.captureVisibleTab(s.windowId,{format:"jpeg",quality:30})).split(",")[1],l="You are a web developer expert at removing anti-adblock walls. Analyze the provided webpage screenshot. Identify the primary overlay, modal, or banner that is blocking the user's view of the content. Also, check if the main page scrolling is disabled (e.g., via 'overflow: hidden' on the html or body). Your goal is to provide two CSS selectors to fix this.",n={type:d.OBJECT,properties:{reasoning:{type:d.STRING},overlaySelector:{type:d.STRING},scrollSelector:{type:d.STRING}},required:["overlaySelector"]};await a("Consulting with Gemini AI...");const u=await o.models.generateContent({model:R,contents:{parts:[{text:l},{inlineData:{mimeType:"image/jpeg",data:i}}]},config:{responseMimeType:"application/json",responseSchema:n,temperature:k}}),m=JSON.parse(u.text);if(!m.overlaySelector||m.overlaySelector.trim()==="")throw new Error("AI could not identify a blocking overlay.");return{overlaySelector:m.overlaySelector.trim(),scrollSelector:m.scrollSelector?.trim()||"body, html"}})}}catch(a){return a.message==="QUOTA_EXCEEDED"?(console.warn("ZenithGuard AI: Quota exceeded."),{error:"QUOTA_EXCEEDED"}):(console.error("ZenithGuard Adblock Wall Defeat Error:",a.message),{error:a.message})}}async function Oe(e){try{return await L(e,async a=>{const r=await A(),o=(await chrome.tabs.captureVisibleTab(a.windowId,{format:"jpeg",quality:W})).split(",")[1],c=`Analyze the provided webpage screenshot for a cookie consent banner. Your goal is to find the single button that is best for user privacy. 
            1. Prioritize buttons with text like 'Reject All', 'Deny', 'Decline', 'Necessary Cookies Only', 'Save Preferences' (if options can be deselected), or 'Manage Settings'.
            2. If no rejection option is visible, as a LAST RESORT, find the button to accept and dismiss the banner, like 'Accept All', 'OK', 'Allow', or 'Got it'.
            3. If no cookie banner or relevant button is visible in the screenshot, you MUST return null for the 'selector' and 'action' properties.
            Return a single, robust CSS selector for the identified button and classify your action.
            IMPORTANT: The returned selector must be a standard, valid CSS selector usable by 'document.querySelector()'. DO NOT use non-standard pseudo-classes like ':has-text()' or ':contains()'.`,i={type:d.OBJECT,properties:{reasoning:{type:d.STRING},selector:{type:d.STRING},action:{type:d.STRING}}},l=await r.models.generateContent({model:R,contents:{parts:[{text:c},{inlineData:{mimeType:"image/jpeg",data:o}}]},config:{responseMimeType:"application/json",responseSchema:i,temperature:k}}),n=JSON.parse(l.text);return!n||!n.selector||n.selector.trim()===""?{result:{selector:null,action:null}}:{result:{selector:n.selector.trim(),action:n.action}}})}catch(t){return t.message==="QUOTA_EXCEEDED"?(console.warn("ZenithGuard AI: Quota exceeded."),{error:"QUOTA_EXCEEDED"}):t.message&&t.message.includes("could not identify a consent button")?{result:{selector:null,action:null}}:t.message&&(t.message.includes("Cannot capture restricted page")||t.message.includes("File access not enabled")||t.message.includes("Tabs cannot be edited")||t.message.includes("Action aborted"))?(console.warn("ZenithGuard Cookie Consent skipped:",t.message),{error:t.message}):(console.error("ZenithGuard Cookie Consent Error:",t.message),{error:t.message})}}const E="tracker-list-cache",Ge=1440*60*1e3;async function P(e=!1){const{trackerListUrl:t}=await chrome.storage.sync.get("trackerListUrl");if(!t||t.includes("YOUR_USERNAME")){console.warn("ZenithGuard: Tracker list URL is not configured. Privacy Insights will be limited to the hard-coded fallback list.");return}if(!e){const a=await chrome.storage.local.get(E);if(a[E]&&Date.now()-a[E].lastUpdated<Ge)return}try{console.log("ZenithGuard: Updating dynamic tracker list...");const a=await fetch(t,{signal:AbortSignal.timeout(15e3)});if(!a.ok)throw new Error(`Failed to fetch remote tracker list: ${a.statusText}`);const r=await a.json();if(!r.SESSION_REPLAY||!r.DATA_BROKER)throw new Error("Fetched tracker list file is invalid.");await chrome.storage.local.set({[E]:{list:r,lastUpdated:Date.now()}}),console.log("ZenithGuard: Dynamic tracker list updated successfully.")}catch(a){console.error("ZenithGuard: Failed to update dynamic tracker list.",a)}}async function Pe(){return(await chrome.storage.local.get(E))[E]?.list||null}const g={},Me=200;function xe(){chrome.webNavigation.onCommitted.addListener(e=>{e.frameId===0&&(g[e.tabId]=[])}),chrome.declarativeNetRequest.onRuleMatchedDebug?.addListener(e=>{const{request:t,rule:a}=e;if(g[t.tabId]){let s=le(a.ruleId);a.ruleListId&&(s="Static Filter List");const o=g[t.tabId].find(c=>c.url===t.url&&!c.statusUpdated);o&&(o.status="blocked",o.matchedRuleInfo={ruleId:a.ruleId,source:s},o.statusUpdated=!0)}let r="tracker";a.ruleListId?a.ruleListId==="easylist"||a.ruleListId==="ublock_annoyances"?r="ad":a.ruleListId==="easyprivacy"&&(r="tracker"):a.ruleId&&(a.ruleId>=Y&&a.ruleId<C||a.ruleId>=C&&a.ruleId<6e4?r="tracker":a.ruleId>=5e3&&a.ruleId<6e3&&(r="ad")),t.url.match(/ad|banner|doubleclick|pagead/i)&&(r="ad"),be(r,t.type)}),chrome.webRequest.onBeforeRequest.addListener(e=>{g[e.tabId]||(g[e.tabId]=[]),g[e.tabId].find(a=>a.url===e.url)||(g[e.tabId].length>=Me&&g[e.tabId].shift(),g[e.tabId].push({url:e.url,type:e.type,initiator:e.initiator,timestamp:e.timeStamp,status:"allowed"}))},{urls:["<all_urls>"]}),chrome.tabs.onRemoved.addListener(e=>{g[e]&&delete g[e]})}function M(e){return g[e]||[]}function Be(e){e&&(g[e]=[])}function He(){chrome.contextMenus.removeAll(()=>{chrome.contextMenus.create({id:"zenithguard-quick-hide",title:"ZenithGuard: Quick Hide Element",contexts:["all"]}),chrome.contextMenus.create({id:"zenithguard-ai-hide-targeted",title:"ZenithGuard: Hide with AI...",contexts:["all"]})})}function Fe(){chrome.contextMenus.onClicked.addListener(async(e,t)=>{const a={"zenithguard-quick-hide":"QUICK_HIDE_ELEMENT","zenithguard-ai-hide-targeted":"START_AI_HIDING_TARGETED"}[e.menuItemId];if(a&&t.id){if(a==="START_AI_HIDING_TARGETED")try{await chrome.scripting.executeScript({target:{tabId:t.id},files:["js/content/ai_hider.js"]})}catch(r){console.error("ZenithGuard: Failed to inject AI Hider script.",r);return}chrome.tabs.sendMessage(t.id,{type:a})}})}const Ye=["linkedin.com","adobe.com","canva.com","dropbox.com","myfitnesspal.com","zynga.com","twitter.com","wattpad.com","quora.com","tumblr.com","myheritage.com","dubsmash.com","verizon.com","vk.com","last.fm"];function We(e,t){if(!e)return!1;const a=e.split(".").reverse();for(let r=0;r<a.length-1;r++){const s=a.slice(0,r+2).reverse().join(".");if(t.includes(s))return!0}return!1}const _={};function je(){chrome.tabs.onUpdated.addListener((e,t,a)=>{e&&a.url&&a.url.startsWith("http")&&(_[e]=a.url)}),chrome.tabs.onRemoved.addListener(async e=>{const t=_[e];if(!t){delete _[e];return}try{const{forgetfulSites:a=[]}=await chrome.storage.sync.get("forgetfulSites"),r=(a||[]).filter(o=>o.enabled).map(o=>o.value);if(r.length===0){delete _[e];return}const s=new URL(t).hostname;if(r.includes(s)){console.log(`ZenithGuard: Forgetful Browsing is clearing data for ${s}`);const o=new URL(t).origin;await chrome.browsingData.remove({origins:[o]},{cache:!0,cookies:!0,localStorage:!0,sessionStorage:!0})}}catch(a){console.warn(`ZenithGuard: Error during Forgetful Browsing cleanup for ${t}:`,a.message)}finally{delete _[e]}}),chrome.tabs.onUpdated.addListener(async(e,t,a)=>{if(t.status==="complete"&&a.url&&a.url.startsWith("http")){const{isBreachWarningEnabled:r}=await chrome.storage.sync.get("isBreachWarningEnabled");if(r){const s=new URL(a.url).hostname;We(s,Ye)&&chrome.tabs.sendMessage(e,{type:"SHOW_BREACH_WARNING",domain:s}).catch(o=>{})}}})}const Ze={SESSION_REPLAY:{domains:["hotjar.com","fullstory.com","logrocket.com","inspectlet.com","clarity.ms"],generate:e=>({type:"warning",icon:"record",message:`This site uses session replay scripts from <strong>${e}</strong>, which can record your clicks and keystrokes.`})},DATA_BROKER:{domains:["criteo.com","liveramp.com","acxiom.com","oracle.com","rlcdn.com"],generate:e=>({type:"alert",icon:"database",message:`A connection was made to <strong>${e}</strong>, a known data broker that collects and sells user information.`})},AD_EXCHANGE:{domains:["adnxs.com","rubiconproject.com","openx.net","pubmatic.com","indexexchange.com"],generate:e=>({type:"alert",icon:"megaphone",message:`This site uses the <strong>${e}</strong> ad exchange, which shares your data across a wide network of advertisers.`})}};async function $e(e){if(!e||!Array.isArray(e)||e.length===0)return[];let t=await Pe(),a=!1;t||(t=Ze,a=!0);const r=[],s=new Set,o=new Set;for(const c of e)try{const i=new URL(c.url).hostname;c.status==="blocked"&&o.add(i);for(const l in t){const n=t[l];for(const u of n.domains)if(i.includes(u)&&!s.has(u)){let m;a?m=n.generate(u):m={type:l==="DATA_BROKER"||l==="AD_EXCHANGE"?"alert":"warning",icon:l==="SESSION_REPLAY"?"record":l==="DATA_BROKER"?"database":"megaphone",message:n.message.replace("{domain}",u)},r.push(m),s.add(u)}}}catch{}return o.size>15&&r.unshift({type:"info",icon:"shield",message:`ZenithGuard blocked requests to <strong>${o.size}</strong> unique tracking domains on this page.`}),r}const I={},Ke=2e4;let x;function $(){return new Promise(e=>{x&&clearTimeout(x),x=setTimeout(async()=>{await f(),e()},500)})}function qe(){chrome.tabs.onRemoved.addListener(e=>{I[e]&&delete I[e]}),chrome.runtime.onMessage.addListener((e,t,a)=>{const r=ze[e.type];return r?((async()=>{try{const s=await r(e,t);a(s)}catch(s){console.error(`Error handling message ${e.type}:`,s),a({error:s.message})}})(),!0):!1})}const ze={TOGGLE_GLOBAL_PROTECTION:async e=>{await chrome.storage.sync.set({isProtectionEnabled:e.data.isEnabled});const t=await chrome.tabs.query({url:["http://*/*","https://*/*"]});for(const a of t)try{chrome.tabs.reload(a.id)}catch{}},APPLY_RULES_AND_RELOAD_TAB:async e=>{await $();try{chrome.tabs.reload(e.data.tabId)}catch{}},APPLY_ALL_RULES:()=>$(),ANALYZE_PAGE_WITH_AI:async e=>{const{tabId:t,pageUrl:a}=e.data;if(I[t]&&Date.now()-I[t]<Ke)return{error:"Please wait before re-running the analysis."};I[t]=Date.now();const r=M(t);return De(t,a,r)},HIDE_ELEMENT_WITH_AI:(e,t)=>Ue(e.data.description,{...e.data.context,tabId:t.tab.id}),DEFEAT_ADBLOCK_WALL:async e=>{const{tabId:t}=e.data,a=async r=>{try{await chrome.tabs.sendMessage(t,{type:"SHOW_PROCESSING_TOAST",message:r})}catch{}};try{const r=await Ne(t,a);if(r.error)throw new Error(r.error);return r}catch(r){throw chrome.tabs.sendMessage(t,{type:"SHOW_ERROR_TOAST",message:r.message}).catch(()=>{}),r}},HANDLE_COOKIE_CONSENT:(e,t)=>Oe(t.tab.id),SUMMARIZE_PRIVACY_POLICY:async e=>{const{domain:t,policyUrl:a}=e.data,r=`privacy-summary-${t}`;try{const s=await ve(a);if(s.error)throw new Error(s.error);await chrome.storage.local.set({[r]:{summary:s,timestamp:Date.now()}})}catch(s){await chrome.storage.local.set({[r]:{error:s.message,timestamp:Date.now()}})}},SELF_HEAL_RULE:(e,t)=>Ce(e.data.selector,t.tab.id,e.data.pageUrl),GET_NETWORK_LOG:(e,t)=>M(e.tabId||t.tab.id),CLEAR_NETWORK_LOG:e=>{e.tabId&&Be(e.tabId)},ADD_TO_NETWORK_BLOCKLIST:async e=>{const{networkBlocklist:t=[]}=await chrome.storage.sync.get("networkBlocklist"),{domain:a}=e;return a&&!t.some(r=>r.value===a)?(t.push({value:a,enabled:!0}),await chrome.storage.sync.set({networkBlocklist:t}),{success:!0}):{success:!1,message:"Rule already exists."}},BULK_ADD_RULES:async e=>{const{networkBlocklist:t,customHidingRules:a}=e.data,r=await chrome.storage.sync.get(["networkBlocklist","customHidingRules"]),s=new Set((r.networkBlocklist||[]).map(n=>n.value));t.forEach(n=>s.add(n));const o=Array.from(s).map(n=>({value:n,enabled:!0})),c=r.customHidingRules||{},{domain:i,selectors:l}=a;if(i&&l.length>0){const n=new Set((c[i]||[]).map(u=>u.value));l.forEach(u=>n.add(u)),c[i]=Array.from(n).map(u=>({value:u,enabled:!0}))}return await chrome.storage.sync.set({networkBlocklist:o,customHidingRules:c}),{success:!0}},TEMPORARILY_ALLOW_DOMAIN:async e=>{const{domain:t}=e;if(!t)return;const{sessionAllowlist:a=[]}=await chrome.storage.session.get("sessionAllowlist");a.includes(t)||(await chrome.storage.session.set({sessionAllowlist:[...a,t]}),await f())},PAUSE_PROTECTION:async()=>{const e=Date.now()+9e5;return await chrome.storage.session.set({protectionPausedUntil:e}),await chrome.alarms.create("resumeProtection",{delayInMinutes:15}),await f(),{success:!0,pauseUntil:e}},RESUME_PROTECTION:async()=>(await chrome.storage.session.remove("protectionPausedUntil"),await chrome.alarms.clear("resumeProtection"),await f(),{success:!0}),GET_PRIVACY_INSIGHTS:e=>$e(M(e.tabId)),GET_HIDING_RULES_FOR_DOMAIN:e=>Ae(e.domain),PREVIEW_ELEMENT:async(e,t)=>{if(t.tab&&t.tab.id)try{await chrome.tabs.sendMessage(t.tab.id,e)}catch{}},CLEAR_PREVIEW:async(e,t)=>{if(t.tab&&t.tab.id)try{await chrome.tabs.sendMessage(t.tab.id,e)}catch{}},FOUND_PRIVACY_POLICY_URL:e=>{chrome.storage.local.set({[`privacy-policy-url-${e.data.domain}`]:e.data.policyUrl})},RESET_SETTINGS_TO_DEFAULTS:async()=>(await we(),{success:!0}),FORCE_UPDATE_ALL_FILTER_LISTS:async()=>(await Promise.all([G(!0),N(),O(!0),P(!0)]),{success:!0}),FORCE_UPDATE_SINGLE_LIST:async e=>{const{filterLists:t=[]}=await chrome.storage.sync.get("filterLists"),a=t.find(r=>r.url===e.url);return a&&(await ae(a),await f()),{success:!0}},REAPPLY_HIDING_RULES:async()=>{(await chrome.tabs.query({url:["http://*/*","https://*/*"],status:"complete"})).forEach(t=>{chrome.tabs.sendMessage(t.id,{type:"REAPPLY_HIDING_RULES"}).catch(()=>{})})}};xe();Fe();je();qe();chrome.runtime.onInstalled.addListener(async e=>{if(await te(),e.reason==="install")chrome.tabs.create({url:"pages/welcome.html"});else if(e.reason==="update"){const t=chrome.runtime.getManifest().version;e.previousVersion!==t&&chrome.tabs.create({url:`pages/whats_new.html?v=${t}`})}He(),await ye(),await f(),await G(!0),await N(),await O(!0),await P(!0),chrome.alarms.create("dailyListUpdate",{periodInMinutes:1440})});chrome.runtime.onStartup.addListener(async()=>{await te(),await f(),await G(),await N(),await O(),await P()});chrome.storage.onChanged.addListener(async(e,t)=>{if(t!=="sync")return;if(e.geminiApiKey&&Le(),["networkBlocklist","customHidingRules","heuristicKeywords","defaultBlocklist","disabledSites","isolationModeSites","filterLists","isHeuristicEngineEnabled","isUrlCleanerEnabled","isMalwareProtectionEnabled","isYouTubeAdBlockingEnabled","isProtectionEnabled","enabledStaticRulesets","forgetfulSites"].some(r=>e[r])){console.log("ZenithGuard: Rule-related setting changed. Re-applying all rules."),await f();const s=(await chrome.tabs.query({url:["http://*/*","https://*/*"],status:"complete"})).map(o=>chrome.tabs.sendMessage(o.id,{type:"REAPPLY_HIDING_RULES"}).catch(c=>{}));await Promise.allSettled(s)}});chrome.alarms.onAlarm.addListener(async e=>{e.name==="dailyListUpdate"&&(await G(),await N(),await O(),await P()),e.name==="resumeProtection"&&(await chrome.storage.session.remove("protectionPausedUntil"),await f(),await chrome.alarms.clear("resumeProtection"))});chrome.commands.onCommand.addListener(async e=>{if(e==="open-settings")chrome.runtime.openOptionsPage();else if(e==="open-logger"){const a=(await chrome.tabs.query({active:!0,currentWindow:!0}))[0]?.id,r=a?`pages/logger.html?tabId=${a}`:"pages/logger.html";chrome.tabs.create({url:r})}else if(e==="toggle-zapper"){const t=await chrome.tabs.query({active:!0,currentWindow:!0});if(t.length>0&&t[0].id)try{await chrome.tabs.sendMessage(t[0].id,{type:"START_ZAPPER_MODE"})}catch(a){console.warn("ZenithGuard: Could not toggle Zapper on this tab. Content script may not be loaded.",a)}}});
