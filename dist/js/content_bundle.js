window.ZenithGuardToastUtils=window.ZenithGuardToastUtils||{};window.ZenithGuardToastUtils.showToast=({message:h,type:n="success",duration:d=3e3,id:r=null})=>{let a=document.getElementById("zg-toast-container");if(a||(a=document.createElement("div"),a.id="zg-toast-container",document.body.appendChild(a)),r){const z=document.getElementById(r);z&&z.remove()}const l=document.createElement("div");r&&(l.id=r),l.className=`zg-toast zg-toast-${n}`;const y={success:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" /></svg>',error:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z" clip-rule="evenodd" /></svg>',loading:'<div class="zg-toast-spinner"></div>',info:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>'}[n]||"";l.innerHTML=`${y}<span>ZenithGuard: ${h}</span>`,a.appendChild(l),d>0&&setTimeout(()=>{l.classList.add("hiding"),l.addEventListener("animationend",()=>l.remove(),{once:!0})},d)};window.ZenithGuardSelectorGenerator=(()=>{function h(r){if(!r)return null;if(r.id&&d(r.id)){const l=`#${CSS.escape(r.id)}`;if(document.querySelectorAll(l).length===1)return l}const a=["data-testid","data-cy","data-test-id","role","name"];for(const l of a){const w=r.getAttribute(l);if(w&&d(w)){const y=`${r.tagName.toLowerCase()}[${l}="${CSS.escape(w)}"]`;if(document.querySelectorAll(y).length===1)return y}}if(r.className&&typeof r.className=="string"){const w=r.className.trim().split(/\s+/).filter(y=>d(y)&&!y.includes(":"));if(w.length>0){const y=r.tagName.toLowerCase()+"."+w.map(z=>CSS.escape(z)).join(".");if(document.querySelectorAll(y).length===1)return y}}return n(r)}function n(r){if(!r||r.nodeType!==Node.ELEMENT_NODE)return null;const a=r;if(a.tagName.toLowerCase()==="body")return"body";if(a.tagName.toLowerCase()==="html")return"html";if(a.id&&d(a.id))return`#${CSS.escape(a.id)}`;const l=n(a.parentElement);if(!l)return null;const w=Array.from(a.parentElement.children),y=a.tagName.toLowerCase(),z=w.filter(S=>S.tagName.toLowerCase()===y);if(z.length===1)return`${l} > ${y}`;const T=z.indexOf(a)+1;return`${l} > ${y}:nth-of-type(${T})`}function d(r){return!(!r||/^\d+$/.test(r)||r.length>50)}return{generate:h}})();window.ZenithGuardInspector=(()=>{const h=g=>{window.ZenithGuardToastUtils&&window.ZenithGuardToastUtils.showToast?window.ZenithGuardToastUtils.showToast(g):console.warn("ZenithGuard: Toast utility not found. Please reload the extension.")};let n=!1,d=null,r=null,a=null,l=[],w=null,y=null;async function z(g){if(!n){n=!0,y=g;try{const t=await chrome.runtime.sendMessage({type:"GET_NETWORK_LOG"});Array.isArray(t)?l=t:l=[]}catch(t){console.error("ZenithGuard Inspector: Could not fetch network log.",t),l=[]}S(),A(),h({message:"Inspector active. Use buttons to hide/block. Press ESC to exit."})}}function T(){n&&(n=!1,y=null,w&&clearTimeout(w),I(),v())}function S(){d=document.createElement("div"),d.id="zg-inspector-highlight",r=document.createElement("div"),r.id="zg-inspector-hud",r.innerHTML=`
            <div class="zg-hud-header">
                <div class="zg-hud-selector" title="No element selected"></div>
                <div class="zg-hud-header-actions">
                    <button class="zg-hud-btn zg-hud-quick-hide-btn">Quick Hide</button>
                    <button class="zg-hud-btn zg-hud-ai-hide-btn">Advanced Hide (AI)</button>
                </div>
            </div>
            <div class="zg-hud-body">
                <div class="zg-hud-requests">
                    <h4>Associated Requests</h4>
                    <div class="zg-hud-request-list"></div>
                </div>
            </div>
            <div class="zg-hud-footer">
                <span class="zg-hud-exit-hint">Hover to select. Use buttons to hide or block. ESC to exit.</span>
            </div>
        `,document.body.appendChild(d),document.body.appendChild(r)}function I(){r?.remove(),d?.remove(),d=null,r=null}function A(){r?.addEventListener("mouseenter",f),r?.addEventListener("click",u,!0),document.addEventListener("mouseover",m,!0),document.addEventListener("keydown",p,!0)}function v(){r?.removeEventListener("mouseenter",f),r?.removeEventListener("click",u,!0),document.removeEventListener("mouseover",m,!0),document.removeEventListener("keydown",p,!0)}function m(g){w&&clearTimeout(w),w=setTimeout(()=>{x(g.target)},120)}function f(){w&&clearTimeout(w)}function u(g){g.preventDefault(),g.stopPropagation();const t=g.target;if(t.classList.contains("zg-hud-block-btn")){const e=t;if(!e.disabled){const i=e.dataset.domain;if(!i)return;e.disabled=!0,chrome.runtime.sendMessage({type:"ADD_TO_NETWORK_BLOCKLIST",domain:i}).then(o=>{o&&o.success?(e.textContent="Blocked!",h({message:`${i} added to blocklist.`})):(e.disabled=!1,h({message:o.message||`Could not block ${i}.`,type:"error"}))}).catch(o=>{e.disabled=!1,console.warn("ZenithGuard Inspector: Could not send block message.",o),h({message:"Error communicating with extension.",type:"error"})})}}else if(t.classList.contains("zg-hud-quick-hide-btn")&&"disabled"in t&&!t.disabled){const e=t;if(a&&y){const i=window.ZenithGuardSelectorGenerator.generate(a);i?(y(i),e.textContent="Hidden!",e.disabled=!0,setTimeout(()=>{n&&e&&(e.textContent="Quick Hide",e.disabled=!1)},1500)):h({message:"Could not generate a unique selector.",type:"error"})}}else if(t.classList.contains("zg-hud-ai-hide-btn")&&a){const e={tag:a.tagName.toLowerCase(),text:a.textContent?.trim().replace(/\s+/g," ").substring(0,200)||""};y&&window.ZenithGuardAIHider.start(i=>y(i),e),T()}}function p(g){g.key==="Escape"&&T()}function x(g){if(!n||!g||g===r||r?.contains(g)||!d||!r)return;a=g;const t=a.getBoundingClientRect();Object.assign(d.style,{width:`${t.width}px`,height:`${t.height}px`,top:`${t.top+window.scrollY}px`,left:`${t.left+window.scrollX}px`}),k(a,t)}function L(g){const t=new Map;if(!g||!l||!Array.isArray(l)||l.length===0)return[];const e=window.location.hostname,i=g.closest("iframe");if(i&&i.src)try{const s=new URL(i.src,window.location.href).href,c=l.find(E=>E.url===s);if(c){const E=new URL(c.url).hostname;E!==e&&t.set(E,c)}}catch{}const b=[g,...Array.from(g.querySelectorAll("*"))].map(s=>s.outerHTML).join(" ").toLowerCase();for(const s of l)if(s.status!=="blocked")try{const c=new URL(s.url).hostname;if(c===e||t.has(c))continue;if(b.includes(s.url.toLowerCase())){t.set(c,s);continue}if(c.split(".").filter(C=>C!=="www"&&C.length>3).some(C=>b.includes(C))){t.set(c,s);continue}}catch{}return Array.from(t.values())}function k(g,t){if(!r)return;const e=t.top+window.scrollY-r.offsetHeight-5,i=t.left+window.scrollX;r.style.top=`${e<0?t.bottom+window.scrollY+5:e}px`,r.style.left=`${Math.max(0,Math.min(window.innerWidth-r.offsetWidth,i))}px`;const o=window.ZenithGuardSelectorGenerator.generate(g)||"...",b=r.querySelector(".zg-hud-selector");b&&(b.textContent=o,b.title=o);const s=L(g),c=r.querySelector(".zg-hud-request-list");if(c)if(s.length>0)c.innerHTML=s.map(E=>{const C=new URL(E.url).hostname,H=E.status==="blocked";return`
                        <div class="zg-hud-request-item" title="${E.url}">
                            <span class="domain">${C}</span>
                            <button class="zg-hud-btn zg-hud-block-btn" data-domain="${C}" ${H?"disabled":""}>
                                ${H?"Blocked":"Block"}
                            </button>
                        </div>
                    `}).join("");else{const E=g.tagName.toLowerCase(),C=["button","a","input","select","textarea"].includes(E)||g.hasAttribute("onclick")||g.getAttribute("role")==="button";let H='<div class="zg-hud-no-requests">No direct network requests found for this element.</div>';C&&(H+='<div class="zg-hud-script-note">Note: Actions on this element may be handled by page-level scripts.</div>'),c.innerHTML=H}}return{start:z,stop:T}})();window.ZenithGuardZapper=(()=>{let h=!1,n=null,d=null,r=null;const a=[];function l(u){h||(h=!0,r=u,a.length=0,y(),T())}function w(){h&&(h=!1,r=null,z(),S())}function y(){n=document.createElement("div"),n.id="zg-zapper-highlight",d=document.createElement("div"),d.id="zg-zapper-banner",d.style.cssText=`
            position: fixed; top: 0; left: 0; width: 100%; z-index: 2147483647;
            background-color: #1f2937; color: #f9fafb; padding: 10px;
            font-family: sans-serif; font-size: 14px; text-align: center;
            display: flex; justify-content: center; align-items: center; gap: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.4);
        `;const u=document.createElement("span");u.innerHTML="âš¡ <strong>Zapper Active</strong>",u.style.color="#00E5FF";const p=document.createElement("button");p.id="zg-zapper-undo-btn",p.textContent="Undo Last",p.disabled=!0,p.style.cssText=`
            background-color: #4b5563; color: white; border: 1px solid #6b7280;
            padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: bold;
            opacity: 0.5; pointer-events: auto;
        `,p.onclick=L=>{L.preventDefault(),L.stopPropagation(),v()};const x=document.createElement("button");x.id="zg-zapper-exit-btn",x.textContent="Exit",x.style.cssText=`
            background-color: #ef4444; color: white; border: 1px solid #dc2626;
            padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: bold;
            pointer-events: auto;
        `,x.onclick=L=>{L.preventDefault(),L.stopPropagation(),w()},d.appendChild(u),d.appendChild(p),d.appendChild(x),document.body.appendChild(n),document.body.appendChild(d)}function z(){d&&d.remove(),n&&n.remove(),n=null,d=null}function T(){document.addEventListener("mouseover",I,!0),document.addEventListener("click",A,!0),document.addEventListener("keydown",f,!0)}function S(){document.removeEventListener("mouseover",I,!0),document.removeEventListener("click",A,!0),document.removeEventListener("keydown",f,!0)}function I(u){if(!h)return;const p=u.target;if(!p||p===d||d?.contains(p)){n&&(n.style.display="none");return}const x=p.getBoundingClientRect();n&&Object.assign(n.style,{display:"block",width:`${x.width}px`,height:`${x.height}px`,top:`${x.top+window.scrollY}px`,left:`${x.left+window.scrollX}px`})}function A(u){if(!h)return;const p=u.target;if(!p||p===d||d?.contains(p)||p===n)return;u.preventDefault(),u.stopPropagation();const x=window.ZenithGuardSelectorGenerator.generate(p);x&&r?(p.style.display="none",p.classList.add("zg-zapped-temp"),r(x),a.push({element:p,selector:x}),m()):console.warn("ZenithGuard Zapper: Could not generate a unique selector.")}async function v(){if(a.length===0)return;const u=a.pop();if(!u)return;const{element:p,selector:x}=u;console.log(`ZenithGuard: Undoing zap for "${x}"`),p&&(p.style.setProperty("display","revert","important"),p.classList.remove("zg-zapped-temp"));const L=window.location.hostname,{customHidingRules:k={}}=await chrome.storage.sync.get("customHidingRules");if(k[L]){const g=k[L].length;k[L]=k[L].filter(t=>t.value!==x),k[L].length<g&&(await chrome.storage.sync.set({customHidingRules:k}),console.log("ZenithGuard: Rule removed from storage."),chrome.runtime.sendMessage({type:"REAPPLY_HIDING_RULES"}))}m()}function m(){const u=document.getElementById("zg-zapper-undo-btn");u&&(a.length>0?(u.disabled=!1,u.style.opacity="1",u.textContent=`Undo (${a.length})`):(u.disabled=!0,u.style.opacity="0.5",u.textContent="Undo"))}function f(u){h&&(u.key==="Escape"?w():(u.metaKey||u.ctrlKey)&&u.key==="z"&&(u.preventDefault(),v()))}return{start:l,stop:w}})();window.ZenithGuardAIHider=(()=>{let h=null,n=null,d=null;function r(){if(document.getElementById("zenithguard-ai-hider-overlay"))return;if(!document.getElementById("zenithguard-theme-styles-runtime")){const f=document.createElement("link");f.id="zenithguard-theme-styles-runtime",f.rel="stylesheet",f.type="text/css",f.href=chrome.runtime.getURL("css/theme.css"),document.head.appendChild(f)}const v=document.createElement("div");v.id="zenithguard-ai-hider-overlay";const m=document.createElement("div");m.id="zenithguard-ai-hider-container",m.innerHTML=`
            <h3 id="zenithguard-ai-hider-title">Describe Element to Hide</h3>
            
            <!-- Initial Input State -->
            <div id="zenithguard-ai-hider-input-view">
                <textarea id="zenithguard-ai-hider-textarea" placeholder="e.g., 'the floating video player in the bottom corner' or 'the newsletter sign-up pop-up'"></textarea>
                <div id="zenithguard-ai-hider-actions">
                    <button id="zenithguard-ai-hider-cancel" class="zenithguard-ai-hider-btn">Cancel</button>
                    <button id="zenithguard-ai-hider-submit" class="zenithguard-ai-hider-btn">Generate Selector</button>
                </div>
            </div>

            <!-- Preview State -->
            <div id="zenithguard-ai-hider-preview-view" class="hidden">
                <input type="text" id="zenithguard-ai-hider-selector-display" readonly>
                <div id="zenithguard-ai-hider-preview-actions">
                    <button id="zenithguard-ai-hider-discard" class="zenithguard-ai-hider-btn">Discard</button>
                    <div>
                        <button id="zenithguard-ai-hider-preview-btn" class="zenithguard-ai-hider-btn zenithguard-ai-hider-preview-btn">Preview</button>
                        <button id="zenithguard-ai-hider-apply-btn" class="zenithguard-ai-hider-btn">Apply & Save</button>
                    </div>
                </div>
            </div>
            
            <!-- Error State -->
            <div id="zenithguard-ai-hider-error-view" class="hidden">
                <p id="zenithguard-ai-hider-error-message"></p>
                <button id="zenithguard-ai-hider-try-again" class="zenithguard-ai-hider-btn">Try Again</button>
            </div>
        `,v.appendChild(m),document.body.appendChild(v),n={overlay:v,container:m,title:document.getElementById("zenithguard-ai-hider-title"),inputView:document.getElementById("zenithguard-ai-hider-input-view"),previewView:document.getElementById("zenithguard-ai-hider-preview-view"),errorView:document.getElementById("zenithguard-ai-hider-error-view"),errorMessage:document.getElementById("zenithguard-ai-hider-error-message"),tryAgainBtn:document.getElementById("zenithguard-ai-hider-try-again"),textarea:document.getElementById("zenithguard-ai-hider-textarea"),submitBtn:document.getElementById("zenithguard-ai-hider-submit"),cancelBtn:document.getElementById("zenithguard-ai-hider-cancel"),selectorDisplay:document.getElementById("zenithguard-ai-hider-selector-display"),previewActions:document.getElementById("zenithguard-ai-hider-preview-actions"),discardBtn:document.getElementById("zenithguard-ai-hider-discard"),previewBtn:document.getElementById("zenithguard-ai-hider-preview-btn"),applyBtn:document.getElementById("zenithguard-ai-hider-apply-btn")},n.textarea.focus()}function a(){n&&(n.overlay&&n.overlay.remove(),chrome.runtime.sendMessage({type:"CLEAR_PREVIEW"}).catch(()=>{}),n=null,h=null,d=null)}function l(v){n&&(n.inputView.classList.add("hidden"),n.previewView.classList.add("hidden"),n.errorView.classList.add("hidden"),v==="input"?(n.title.textContent="Describe Element to Hide",n.inputView.classList.remove("hidden"),n.textarea.focus()):v==="preview"?(n.title.textContent="Generated Selector",n.previewView.classList.remove("hidden")):v==="error"&&(n.title.textContent="An Error Occurred",n.errorView.classList.remove("hidden")))}function w(v){n&&(v?(n.submitBtn.disabled=!0,n.submitBtn.innerHTML='<div class="zenithguard-ai-hider-spinner"></div><span>Generating...</span>',n.submitBtn.style.display="flex",n.submitBtn.style.alignItems="center"):(n.submitBtn.disabled=!1,n.submitBtn.innerHTML="Generate Selector"))}function y(v){if(!n)return;d=v,l("preview"),n.selectorDisplay.value=v,n.previewActions.style.display="flex",n.previewActions.style.justifyContent="space-between";const m=n.previewActions.querySelector("div");m&&(m.style.display="flex",m.style.gap="10px")}function z(v){n&&(l("error"),v==="QUOTA_EXCEEDED"?n.errorMessage.textContent="The AI is currently busy due to high demand. Please try again in a few moments.":n.errorMessage.textContent=v)}async function T(v){if(!n)return;const m=n.textarea.value.trim();if(m.length<5){z("Please provide a more detailed description.");return}w(!0);try{const f=await chrome.runtime.sendMessage({type:"HIDE_ELEMENT_WITH_AI",data:{description:m,context:v}});if(f.error)throw new Error(f.error);if(f.selector)y(f.selector);else throw new Error("AI did not return a valid selector.")}catch(f){z(f.message)}finally{w(!1)}}function S(){if(!n)return;const m={type:n.previewBtn.classList.toggle("active")?"PREVIEW_ELEMENT":"CLEAR_PREVIEW",selector:d};chrome.runtime.sendMessage(m).catch(()=>{})}function I(){d&&h&&h(d),a()}function A(v,m=null){if(!n&&(h=v,r(),n=n,!!n)){if(m&&m.tag){let f=`the ${m.tag} element`;if(m.id&&(f+=` with ID #${m.id}`),m.classes&&typeof m.classes=="string"&&m.classes.trim()){const u=m.classes.trim().replace(/\s+/g," ");f+=` with classes "${u}"`}m.text&&(f+=` containing text like "${m.text.substring(0,80)}..."`),n.textarea.value=f}n.submitBtn.addEventListener("click",()=>T(m)),n.cancelBtn.addEventListener("click",a),n.previewBtn.addEventListener("click",S),n.applyBtn.addEventListener("click",I),n.discardBtn.addEventListener("click",a),n.tryAgainBtn.addEventListener("click",()=>l("input")),n.overlay.addEventListener("click",f=>{n&&f.target===n.overlay&&a()}),document.addEventListener("keydown",f=>{f.key==="Escape"&&a()},{once:!0})}}return{start:A}})();(async()=>{const h=t=>{window.ZenithGuardToastUtils&&window.ZenithGuardToastUtils.showToast?window.ZenithGuardToastUtils.showToast(t):console.warn("ZenithGuard: Toast utility not found. Please reload the extension.")};let n=!1;function d(){const t=`zg-breach-dismissed-${window.location.hostname}`;if(sessionStorage.getItem(t))return;const e=document.createElement("div");e.className="zenithguard-breach-warning",e.innerHTML=`
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.22 1.754a.75.75 0 011.56 0l4.25 8.5a.75.75 0 01-.655.996h-8.5a.75.75 0 01-.655-.996l4.25-8.5zM9 9a.75.75 0 01.75.75v2.5a.75.75 0 01-1.5 0v-2.5A.75.75 0 019 9zm0 6a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>
            <span><strong>Security Alert:</strong> This site has a known history of data breaches. Be careful with your passwords and personal information.</span>
            <button class="z-dismiss-btn" title="Dismiss">&times;</button>
        `;const i=e.querySelector(".z-dismiss-btn");i&&i.addEventListener("click",()=>{e.remove(),sessionStorage.setItem(t,"true")}),document.body.prepend(e)}function r(){document.addEventListener("focusin",t=>{const e=t.target;e&&e.tagName==="INPUT"&&e.type==="password"&&n&&h({message:"Warning: This site has a known data breach. Do not re-use an old password!",type:"error",duration:6e3})})}let a=!1;const l="zg-processing-toast";chrome.runtime.onMessage.addListener((t,e,i)=>{const b={START_INSPECTOR_MODE:()=>window.ZenithGuardInspector.start(A),START_ZAPPER_MODE:()=>window.ZenithGuardZapper.start(A),QUICK_HIDE_ELEMENT:s=>f(s.targetElementId),START_AI_HIDING_TARGETED:s=>u(s.targetElementId),PREVIEW_ELEMENT:s=>p(s.selector,!0),CLEAR_PREVIEW:()=>p(null,!1),PREVIEW_MANUAL_RULE:s=>x(s.selector),REAPPLY_HIDING_RULES:()=>w(!1),EXECUTE_ADBLOCK_WALL_FIX:s=>L(s.selectors),SHOW_PROCESSING_TOAST:s=>h({message:s.message,type:"loading",id:l,duration:0}),SHOW_ERROR_TOAST:s=>{const c=document.getElementById(l);c&&c.remove(),h({message:s.message,type:"error"})},SHOW_BREACH_WARNING:s=>{n=!0,d()}}[t.type];return b&&(b(t),i({success:!0})),!0});async function w(t=!1){try{const e=window.location.hostname,i=await chrome.storage.sync.get(["customHidingRules","isCookieBannerHidingEnabled","isSelfHealingEnabled","isPerformanceModeEnabled","isSandboxedIframeEnabled","disabledSites","isProtectionEnabled"]),{customHidingRules:o={},isCookieBannerHidingEnabled:b,isSelfHealingEnabled:s,isPerformanceModeEnabled:c,isSandboxedIframeEnabled:E,disabledSites:C=[],isProtectionEnabled:H=!0}=i;if(!H||C.includes(e)){I([],"custom"),I([],"filterList"),console.log(H?"ZenithGuard: Cosmetic filtering disabled for this site.":"ZenithGuard: Global protection is OFF. Removing cosmetic rules.");return}a=!!c;const G=o[e]||[];I(G,"custom"),E&&v(),t&&!a&&(s&&m(G,e),b&&k());const B=await chrome.runtime.sendMessage({type:"GET_HIDING_RULES_FOR_DOMAIN",domain:e});B&&B.rules&&I(B.rules,"filterList")}catch(e){const i=String(e.message||e);i.includes("context invalidated")||i.includes("Cannot read properties of undefined")?console.log("ZenithGuard: Context invalidated on navigation. Halting stale script."):console.warn("ZenithGuard: Could not re-apply hiding rules.",e)}}function y(){const t="zenithguard-youtube-cosmetic-styles";let e=document.getElementById(t);e||(e=document.createElement("style"),e.id=t,(document.head||document.documentElement).appendChild(e));const i=[".video-ads",".ytp-ad-module",".ytp-ad-player-overlay",".ytp-ad-image-overlay",".ytp-ad-text-overlay","ytd-promoted-sparkles-web-renderer","ytd-display-ad-renderer","ytd-promoted-video-renderer","ytd-in-feed-ad-layout-renderer","ytd-ad-slot-renderer","ytd-promoted-sparkles-text-search-renderer",".ytp-ad-skip-button-container",".ytp-ad-preview-container","#player-ads","#masthead-ad",".ytp-paid-content-overlay"];e.textContent=`${i.join(", ")} { display: none !important; }`}function z(){if(!document.getElementById("zenithguard-yt-interceptor"))try{const t=document.createElement("script");t.id="zenithguard-yt-interceptor",t.src=chrome.runtime.getURL("js/content/yt_interceptor.js"),(document.head||document.documentElement).appendChild(t),t.onload=()=>{t.remove()}}catch(t){const e=String(t.message||t);e.includes("context invalidated")||e.includes("Cannot read properties of undefined")?console.log("ZenithGuard: Context invalidated on navigation. Halting stale interceptor script."):console.warn("ZenithGuard: Could not inject YT interceptor.",t)}}function T(){if(window.location.hostname==="www.youtube.com"){if(!document.body){window.addEventListener("DOMContentLoaded",S,{once:!0});return}S()}}function S(){z(),y();let t=null;new MutationObserver(i=>{t&&clearTimeout(t),t=setTimeout(()=>{w(!1),y(),z()},150)}).observe(document.body,{childList:!0,subtree:!0}),console.log("ZenithGuard: Persistent cosmetic filtering & ad interception enabled for YouTube.")}function I(t,e){if(!t||t.length===0){const s=`zenithguard-styles-${e}`,c=document.getElementById(s);c&&(c.textContent="");return}const i=`zenithguard-styles-${e}`;let o=document.getElementById(i);o||(o=document.createElement("style"),o.id=i,(document.head||document.documentElement).appendChild(o));const b=t.filter(s=>s.enabled).map(s=>s.value);if(b.length>0){const s=b.join(", ");o.textContent=`${s}:not(#zg-zapper-highlight):not(#zg-inspector-highlight) { display: none !important; }`}else o.textContent=""}async function A(t){try{const e=window.location.hostname;let{customHidingRules:i={}}=await chrome.storage.sync.get("customHidingRules");i[e]||(i[e]=[]),i[e].some(o=>o.value===t)?h({message:"This hiding rule already exists."}):(i[e].push({value:t,enabled:!0}),await chrome.storage.sync.set({customHidingRules:i}),h({message:"Hiding rule saved!"}))}catch(e){String(e.message||e).includes("Extension context invalidated.")?h({message:"Extension was reloaded. Please try again.",type:"error"}):(console.error("ZenithGuard: Failed to save hiding rule.",e),h({message:"Failed to save rule.",type:"error"}))}}function v(){const t=Array.from(document.querySelectorAll("iframe")),e=window.location.hostname,i="allow-scripts allow-same-origin allow-presentation allow-popups allow-forms";for(const o of t)try{o.src&&new URL(o.src).hostname!==e&&(o.hasAttribute("sandbox")||o.setAttribute("sandbox",i))}catch{}}async function m(t,e){for(const[i,o]of t.entries()){if(!o.enabled||!o.value)continue;const b=o.lastHealAttempt||0,s=1440*60*1e3;if(!(Date.now()-b<s)&&(document.readyState!=="complete"&&await new Promise(c=>window.addEventListener("load",c,{once:!0})),document.querySelector(o.value)===null)){console.log(`ZenithGuard: Broken selector detected: ${o.value}. Attempting to self-heal.`);try{const c=await chrome.runtime.sendMessage({type:"SELF_HEAL_RULE",data:{selector:o.value,pageUrl:window.location.href}});if(c.error)console.warn(`ZenithGuard: AI self-heal failed for ${o.value}. Error: ${c.error}`);else if(c.newSelector){console.log(`ZenithGuard: AI proposed new selector: ${c.newSelector}`);let{customHidingRules:C={}}=await chrome.storage.sync.get("customHidingRules");if(!C[e]||!C[e][i])continue;C[e][i].value=c.newSelector,C[e][i].lastHealed=Date.now(),C[e][i].lastHealAttempt=Date.now(),await chrome.storage.sync.set({customHidingRules:C}),I(C[e],"custom"),c.newSelector&&h({message:"An old hiding rule was automatically repaired by AI."})}let{customHidingRules:E={}}=await chrome.storage.sync.get("customHidingRules");E[e]&&E[e][i]&&(E[e][i].lastHealAttempt=Date.now(),await chrome.storage.sync.set({customHidingRules:E}))}catch(c){const E=String(c.message||c);!E.includes("Extension context invalidated.")&&!E.includes("Cannot read properties of undefined")&&console.warn(`ZenithGuard: Error during self-heal message: ${E}`)}}}}function f(t){const e=i=>{const o=i.target,b=window.ZenithGuardSelectorGenerator.generate(o);b&&A(b),document.removeEventListener("contextmenu",e,{capture:!0})};document.addEventListener("contextmenu",e,{once:!0,capture:!0})}function u(t){const e=i=>{const o=i.target,b={tag:o.tagName.toLowerCase(),id:o.id,classes:o.className,text:o.textContent?.trim().replace(/\s+/g," ").substring(0,200)||""};window.ZenithGuardAIHider.start(A,b),document.removeEventListener("contextmenu",e,{capture:!0})};document.addEventListener("contextmenu",e,{once:!0,capture:!0})}function p(t,e){const i="zenithguard-preview-style";let o=document.getElementById(i);e&&t?(o||(o=document.createElement("style"),o.id=i,(document.head||document.documentElement).appendChild(o)),o.textContent=`${t} { outline: 3px dashed #d97706 !important; background-color: rgba(251, 191, 36, 0.3) !important; box-shadow: 0 0 0 9999px rgba(0,0,0,0.5); }`):o&&o.remove()}function x(t){const e="zenithguard-manual-preview-style";let i=document.getElementById(e);i&&i.remove(),i=document.createElement("style"),i.id=e,i.textContent=`
            ${t} { 
                outline: 3px solid #22c55e !important; 
                box-shadow: 0 0 15px #22c55e, 0 0 0 9999px rgba(34, 197, 94, 0.2) !important;
                transition: outline 0.3s, box-shadow 0.3s;
                border-radius: 4px;
            }
        `,(document.head||document.documentElement).appendChild(i),setTimeout(()=>{const o=document.getElementById(e);o&&o.remove()},2500)}function L(t){const e=document.getElementById(l);e&&e.remove();const{overlaySelector:i,scrollSelector:o}=t;if(!i)return;const b="zenithguard-adblock-wall-fix";let s=document.getElementById(b);s||(s=document.createElement("style"),s.id=b,(document.head||document.documentElement).appendChild(s));let c=`${i} { display: none !important; opacity: 0 !important; pointer-events: none !important; }`;o&&(c+=`
${o} { overflow: visible !important; position: static !important; }`),s.textContent=c,h({message:"AI Anti-Adblock Wall activated."})}function k(){setTimeout(async()=>{try{const t=await chrome.runtime.sendMessage({type:"HANDLE_COOKIE_CONSENT"});if(t.error){console.log(`ZenithGuard AI Cookie Consent: ${t.error}`);return}const{selector:e,action:i}=t.result;if(!e)return;try{const o=document.querySelector(e);o&&g(o)?(o.click(),h({message:i==="REJECT"?"AI rejected tracking cookies for you.":"AI accepted cookies for you."})):o&&console.log(`ZenithGuard AI Cookie Consent: Found selector "${e}", but element was not visible or clickable.`)}catch(o){console.warn(`ZenithGuard AI Cookie Consent: AI returned an invalid selector "${e}". Error: ${o.message}`)}}catch(t){const e=String(t.message||t);!e.includes("Extension context invalidated.")&&!e.includes("Cannot read properties of undefined")&&console.warn(`ZenithGuard AI Cookie Consent failed: ${e}`)}},2e3)}await w(!0),T(),r();function g(t){return t?!!(t.offsetWidth||t.offsetHeight||t.getClientRects().length):!1}})();
